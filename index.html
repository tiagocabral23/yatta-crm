<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#111827">
    <title>TRAIL SYSTEM v3.9.22 | Metas & Vendas</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* TRAIL SYSTEM - v3.9.22 
           Estilos Visuais
        */

        /* --- ESTILO VISUAL --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; color: #1f2937; display: flex; height: 100vh; overflow: hidden; }

        /* MENU LATERAL */
        #sidebar { width: 260px; background-color: #111827; color: #fff; display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s ease; z-index: 1000; }
        .brand { padding: 25px; text-align: center; background: #000; border-bottom: 2px solid #fbbf24; display: flex; justify-content: space-between; align-items: center; }
        .brand h1 { color: #fbbf24; font-size: 20px; font-weight: 900; font-style: italic; letter-spacing: 1px; margin: 0 auto; }
        .nav-menu { flex: 1; padding: 20px 0; overflow-y: auto; }
        .nav-item { width: 100%; padding: 15px 25px; background: transparent; border: none; color: #9ca3af; text-align: left; font-size: 13px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 10px; text-transform: uppercase; transition: 0.2s; }
        .nav-item:hover { background-color: #1f2937; color: #fff; }
        .nav-item.active { background-color: #fbbf24; color: #000; border-right: 4px solid #b45309; }
        .sidebar-footer { padding: 20px; text-align: center; font-size: 11px; color: #6b7280; border-top: 1px solid #1f2937; background: #0f172a; }

        /* BOT√ÉO MOBILE */
        .btn-close-sidebar { display: none; background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; }
        .btn-hamburger { display: none; background: none; border: none; font-size: 24px; cursor: pointer; color: #1f2937; margin-right: 15px; }

        /* √ÅREA PRINCIPAL */
        #main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; width: 100%; }
        header { height: 60px; background: #fff; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .header-left { display: flex; align-items: center; }
        .viewport { flex: 1; padding: 20px; overflow-y: auto; background: #f3f4f6; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS DO DASHBOARD E RELAT√ìRIO */
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card-stat { background: #fff; padding: 15px 20px; border-radius: 10px; border: 1px solid #e5e7eb; border-top: 4px solid #fbbf24; }
        .card-stat label { display: block; font-size: 10px; font-weight: 800; text-transform: uppercase; color: #6b7280; margin-bottom: 5px; }
        .card-stat .value { font-size: 20px; font-weight: 900; color: #111827; }

        /* CARDS DE INVENT√ÅRIO */
        .inventory-panel-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .inv-card { background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #e5e7eb; display: flex; flex-direction: column; position: relative; overflow: hidden;}
        .inv-card.critical { border-color: #ef4444; background: #fff5f5; }
        .inv-card.blocked { border-color: #f59e0b; background: #fffbeb; } 
        .inv-label { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #6b7280; margin-bottom: 5px; }
        .inv-value { font-size: 18px; font-weight: 900; color: #111827; }
        .inv-card.critical .inv-value { color: #991b1b; }
        .inv-card.blocked .inv-value { color: #b45309; }

        /* TABELAS */
        .data-card { background: #fff; border-radius: 10px; border: 1px solid #e5e7eb; overflow: hidden; margin-bottom: 20px; }
        .data-card-header { background: #1f2937; color: #fbbf24; padding: 10px 15px; font-weight: 800; text-transform: uppercase; font-size: 11px; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { padding: 10px 15px; font-size: 10px; text-transform: uppercase; background: #f9fafb; color: #4b5563; text-align: left; border-bottom: 1px solid #e5e7eb; }
        td { padding: 10px 15px; font-size: 12px; border-bottom: 1px solid #f3f4f6; color: #374151; vertical-align: middle; }

        /* RANKING */
        .ranking-row { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #f3f4f6; align-items: center; }
        .ranking-pos { font-weight: 900; font-size: 14px; color: #fbbf24; background: #1f2937; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; }
        .ranking-name { font-weight: 700; font-size: 12px; }
        .ranking-val { font-weight: 800; font-size: 12px; color: #059669; }

        /* KANBAN */
        .kanban-board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; height: calc(100vh - 200px); align-items: flex-start; }
        .kanban-col { background: #e5e7eb; min-width: 280px; max-width: 280px; border-radius: 8px; display: flex; flex-direction: column; max-height: 100%; transition: background 0.3s; border: 2px solid transparent; }
        .kanban-col.drag-over { background: #d1d5db; border-color: #9ca3af; border-style: dashed; }
        .kanban-header { padding: 10px 15px; font-weight: 800; text-transform: uppercase; font-size: 11px; border-radius: 8px 8px 0 0; display: flex; flex-direction: column; gap: 2px; color: #fff; }
        .kanban-header-total { font-size: 10px; opacity: 0.9; font-weight: 600; }
        .kanban-list { padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; min-height: 100px; }

        .card { background: #fff; padding: 12px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #111827; cursor: grab; font-size: 12px; transition: transform 0.2s; position: relative; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.15); border-left-color: #fbbf24; } 
        .card:active { cursor: grabbing; }
        .card.dragging { opacity: 0.5; transform: rotate(2deg); }
        .card-tags { display: flex; gap: 5px; margin-bottom: 5px; justify-content: space-between; align-items: center;}
        .tag { padding: 2px 5px; background: #f3f4f6; border-radius: 3px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .card-action { margin-top: 8px; font-size: 10px; background: #eff6ff; color: #1e40af; padding: 4px; border-radius: 4px; display: flex; align-items: center; gap: 4px; }

        /* BOT√ïES NO CARD */
        .card-btn-group { display: flex; gap: 3px; }
        .btn-card-icon { background: transparent; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer; padding: 2px 6px; font-size: 10px; color: #6b7280; transition:0.2s; }
        .btn-card-icon:hover { background: #fbbf24; border-color: #d97706; color: #000; }
        .btn-card-delete:hover { background: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        /* RELAT√ìRIOS */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #e5e7eb; align-items: flex-end; flex-wrap: wrap; }
        .filter-group { flex: 1; min-width: 150px; }
        .filter-group label { display: block; font-size: 10px; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; color: #4b5563; }
        .filter-group input, .filter-group select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; }

        /* HIST√ìRICO (TIMELINE) */
        .timeline-item { padding: 10px 0 10px 20px; border-left: 2px solid #e5e7eb; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: -6px; top: 15px; width: 10px; height: 10px; border-radius: 50%; background: #fbbf24; border: 2px solid #fff; }
        .timeline-date { font-size: 10px; color: #6b7280; font-weight: 700; }
        .timeline-action { font-size: 12px; font-weight: 800; color: #111827; }
        .timeline-detail { font-size: 11px; color: #374151; margin-top: 2px; }
        .timeline-user { font-size: 9px; color: #9ca3af; font-style: italic; margin-top: 2px; }

        /* BOTOES E MODAIS */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 700; font-size: 11px; text-transform: uppercase; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-main { background: #fbbf24; color: #000; }
        .btn-dark { background: #1f2937; color: #fbbf24; }
        .btn-small { padding: 4px 8px; font-size: 10px; }
        .btn-danger { background: #fee2e2; color: #991b1b; }
        .btn-whatsapp { background: #25D366; color: #fff; border: 1px solid #20bd5a; font-size: 10px; padding: 4px 8px; text-decoration: none; border-radius: 4px; }
        .btn-whatsapp:hover { background: #128c7e; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal.active { display: flex; }
        .modal-box { background: #fff; width: 100%; max-width: 450px; padding: 25px; border-radius: 12px; max-height: 90vh; overflow-y: auto; }
        .form-item { margin-bottom: 12px; }
        .form-item label { display: block; font-size: 10px; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; color: #4b5563; }
        .form-item input, .form-item select, .form-item textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: #fff; font-family: inherit; }

        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #111827; color: #fbbf24; padding: 10px 20px; border-radius: 8px; font-weight: 700; font-size: 12px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 3000; }
        #user-overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .user-select-card { background: #1f2937; color: #fff; padding: 20px; border-radius: 10px; cursor: pointer; text-align: center; width: 150px; border: 2px solid transparent; }
        .user-select-card:hover { border-color: #fbbf24; transform: translateY(-2px); }

        .grid-2-col { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

        /* HELPER */
        .gestor-only { display: none !important; }
        .show-gestor { display: inline-flex !important; }
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #b45309; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        /* AGENDA STYLES */
        .agenda-group { margin-bottom: 20px; }
        .agenda-group h4 { font-size: 11px; text-transform: uppercase; margin-bottom: 10px; color: #6b7280; font-weight: 800; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; }
        .agenda-item { background: #fff; border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .agenda-item.delayed { border-left: 4px solid #ef4444; }
        .agenda-item.today { border-left: 4px solid #f59e0b; }
        .agenda-item.future { border-left: 4px solid #10b981; }
        .agenda-info { flex: 1; }
        .agenda-client { font-weight: 800; font-size: 13px; color: #1f2937; }
        .agenda-desc { font-size: 12px; color: #4b5563; margin-top: 2px; }
        .agenda-date { font-size: 10px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-right: 15px; }

        /* MOBILE RESPONSIVE */
        @media (max-width: 900px) { 
            .grid-2-col { grid-template-columns: 1fr; } 
        }

        @media (max-width: 768px) {
            #sidebar { position: fixed; top: 0; left: 0; bottom: 0; transform: translateX(-100%); width: 260px; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
            #sidebar.open { transform: translateX(0); }
            .btn-close-sidebar { display: block; }
            .btn-hamburger { display: block; }
            .kanban-board { height: auto; min-height: 500px; }
        }

        /* ESTILOS DE IMPRESS√ÉO */
        @media print {
            #sidebar, header, .filter-bar button, .modal, #toast, .nav-menu { display: none !important; }
            #main-content { margin: 0; padding: 0; height: auto; overflow: visible; }
            .viewport { overflow: visible; padding: 0; background: #fff; }
            .tab-content { display: none; }
            #tab-relatorios { display: block !important; }
            body { background: #fff; color: #000; height: auto; overflow: visible; }
            .data-card { border: 1px solid #000; box-shadow: none; margin-bottom: 20px; }
            .data-card-header { background: #ddd; color: #000; font-weight: bold; border-bottom: 1px solid #000; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #ccc; color: #000; padding: 8px; font-size: 10px; }
            th { background: #eee; }
            .grid-stats .card-stat { border: 1px solid #000; break-inside: avoid; }
            .card-stat .value { color: #000 !important; }
            .badge { border: 1px solid #000; background: none !important; color: #000 !important; }
        }
    </style>
</head>
<body>

    <div id="user-overlay">
        <div style="text-align: center;">
            <h2 style="color: #fff; margin-bottom: 30px;">IDENTIFIQUE-SE</h2>
            <div id="user-list-grid" style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;"></div>
        </div>
    </div>

    <aside id="sidebar">
        <div class="brand">
            <h1>TRAIL SYSTEM</h1>
            <button class="btn-close-sidebar" onclick="APP.toggleMenu()">√ó</button>
        </div>
        <nav class="nav-menu">
            <button onclick="APP.nav('dashboard')" id="btn-dashboard" class="nav-item active">üìä Dashboard</button>
            <button onclick="APP.nav('vendas')" id="btn-vendas" class="nav-item">üí∞ Cat√°logo</button> <!-- NOME ALTERADO -->
            <button onclick="APP.nav('agenda')" id="btn-agenda" class="nav-item">üìÖ Agenda</button>
            <button onclick="APP.nav('funil')" id="btn-funil" class="nav-item">‚ö° Funil</button>
            <button onclick="APP.nav('clientes')" id="btn-clientes" class="nav-item">üìá Clientes</button>
            <button onclick="APP.nav('estoque')" id="btn-estoque" class="nav-item">üöú Estoque</button>
            <button onclick="APP.nav('relatorios')" id="btn-relatorios" class="nav-item">üìà Relat√≥rios</button>
            <button onclick="APP.nav('equipe')" id="btn-equipe" class="nav-item">üë• Equipe</button>
        </nav>
        <div class="sidebar-footer">
            <div id="user-info" style="color: #fbbf24; font-weight: 800; margin-bottom: 5px;"></div>
            <button onclick="APP.logout()" style="background:none; border:1px solid #374151; color:#9ca3af; padding:4px; width:100%; cursor:pointer;">SAIR</button>
            <div style="margin-top:15px; font-size:9px; opacity:0.5; color: #fbbf24;">v3.9.22 (Metas)</div>
        </div>
    </aside>

    <main id="main-content">
        <header>
            <div class="header-left">
                <button class="btn-hamburger" onclick="APP.toggleMenu()">‚ò∞</button>
                <h2 id="page-title">DASHBOARD</h2>
            </div>
            <button onclick="APP.exportData()" class="btn btn-dark" style="font-size:10px;">üíæ Backup (Excel)</button>
        </header>

        <div class="viewport">
            <!-- ABA DASHBOARD -->
            <section id="tab-dashboard" class="tab-content active">
                <div class="grid-stats">
                    <div class="card-stat"><label id="lbl-faturamento">Faturamento (M√™s)</label><div id="kpi-total" class="value">R$ 0,00</div></div>
                    <div class="card-stat"><label>Valor em Carteira</label><div id="kpi-pipeline" class="value" style="color:#8b5cf6">R$ 0,00</div></div>
                    <div class="card-stat"><label>Margem de Venda Total</label><div id="kpi-margin" class="value">R$ 0,00</div></div>
                </div>
                
                <!-- NOVO: WIDGET DE METAS -->
                <div class="data-card" style="margin-bottom: 20px;">
                    <div class="data-card-header">üéØ Metas do M√™s</div>
                    <div id="goals-container" style="padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <!-- Barras de progresso inseridas via JS -->
                    </div>
                </div>

                <div id="dash-inventory-grid" class="inventory-panel-grid"></div>

                <div class="grid-2-col">
                    <div class="data-card">
                        <div class="data-card-header">Performance Equipe</div>
                        <div class="table-responsive">
                            <table id="table-performance">
                                <thead><tr><th>Nome</th><th>Em Aberto</th><th>Ganhos</th><th>% Conv.</th><th>Total</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="data-card">
                        <div class="data-card-header">üèÜ Top Vendedores</div>
                        <div id="ranking-list" style="padding: 10px;"></div>
                    </div>
                </div>
            </section>

            <!-- NOVA ABA: CAT√ÅLOGO DE VENDAS (SUBSTITUI VENDAS DETALHADAS) -->
            <section id="tab-vendas" class="tab-content">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="search-catalog" onkeyup="APP.renderCatalog()" placeholder="Buscar item no cat√°logo..." style="padding: 10px; flex: 1; border-radius: 6px; border: 1px solid #d1d5db;">
                </div>
                <div class="data-card">
                    <div class="data-card-header">Cat√°logo & Pre√ßos</div>
                    <div class="table-responsive">
                        <table id="table-catalog">
                            <!-- CABE√áALHO PREENCHIDO VIA JS CONFORME PERMISS√ÉO -->
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ABA AGENDA -->
            <section id="tab-agenda" class="tab-content">
                <div class="data-card" style="padding: 15px;">
                    <div id="agenda-content"></div>
                </div>
            </section>

            <!-- ABA FUNIL -->
            <section id="tab-funil" class="tab-content">
                <div style="margin-bottom: 15px; display: flex; justify-content: space-between;">
                    <h3 style="font-weight:900;">MEU FUNIL</h3>
                    <div style="display:flex; gap:10px;">
                        <select id="filter-user" onchange="APP.renderKanban()" style="display:none; padding:5px;"><option value="all">Todos</option></select>
                        <button onclick="APP.prepareDeal()" class="btn btn-main">+ Oportunidade</button>
                    </div>
                </div>
                <div id="kanban-board" class="kanban-board"></div>
            </section>

            <!-- ABA CLIENTES -->
            <section id="tab-clientes" class="tab-content">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="search-client" onkeyup="APP.renderClients()" placeholder="Buscar Cliente..." style="padding: 10px; flex: 1; border-radius: 6px; border: 1px solid #d1d5db;">
                    <button class="btn btn-main" onclick="APP.modal('modal-client')">+ Novo Cliente</button>
                </div>
                <div class="data-card">
                    <div class="table-responsive">
                        <table id="table-clients">
                            <thead><tr><th>Cliente / CPF</th><th>Contato</th><th>Cidade/Obs</th><th>Total Gasto</th><th>Docs</th><th>A√ß√£o</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ABA ESTOQUE -->
            <section id="tab-estoque" class="tab-content">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="search-stock" onkeyup="APP.renderStock()" placeholder="Buscar..." style="padding: 10px; flex: 1; border-radius: 6px; border: 1px solid #d1d5db;">
                    <input type="file" id="file-import" style="display:none" onchange="APP.importStock(event)">
                    <button id="btn-import-stock" class="btn btn-dark gestor-ctrl" onclick="document.getElementById('file-import').click()">üìÇ Importar CSV</button>
                    <button id="btn-new-stock" class="btn btn-main gestor-ctrl" onclick="APP.prepareStock()">+ Novo Item</button>
                </div>
                <div class="data-card">
                    <div class="data-card-header">Dispon√≠vel no P√°tio</div>
                    <div class="table-responsive">
                        <table id="table-stock">
                            <thead><tr><th>Tipo</th><th>Modelo</th><th>Chassi</th><th>Custo</th><th>Dias</th><th>Giro</th><th>Status</th><th>A√ß√£o</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="data-card" style="margin-top: 30px; border-color: #9ca3af;">
                    <div class="data-card-header" style="background: #4b5563; color: #fff;">Itens Vendidos / Arquivados</div>
                    <div class="table-responsive">
                        <table id="table-stock-sold">
                            <thead><tr><th>Data Venda</th><th>Modelo</th><th>Chassi</th><th>Custo</th><th>Cliente</th><th>A√ß√£o</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ABA RELAT√ìRIOS -->
            <section id="tab-relatorios" class="tab-content">
                <div class="filter-bar">
                    <div class="filter-group"><label>Data In√≠cio</label><input type="date" id="rep-start"></div>
                    <div class="filter-group"><label>Data Fim</label><input type="date" id="rep-end"></div>
                    <div class="filter-group">
                        <label>Origem</label>
                        <select id="rep-source">
                            <option value="all">Todas</option>
                            <option value="Loja/Passante">Loja / Passante</option>
                            <option value="Indicacao">Indica√ß√£o</option>
                            <option value="Visita">Visita</option>
                            <option value="Instagram">Instagram / Facebook</option>
                            <option value="Google">Google / Site</option>
                            <option value="Feira">Feira / Evento</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div class="filter-group gestor-ctrl">
                        <label>Vendedor</label>
                        <select id="rep-seller"><option value="all">Todos</option></select>
                    </div>
                    <button class="btn btn-main" onclick="APP.renderReports()">Filtrar</button>
                    <button class="btn btn-dark" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                </div>
                <div class="grid-stats">
                    <div class="card-stat"><label>Total Vendido (Per√≠odo)</label><div id="rep-total-val" class="value" style="color:#0ea5e9">R$ 0,00</div></div>
                    <div class="card-stat"><label>Vendas Fechadas</label><div id="rep-total-count" class="value">0</div></div>
                </div>
                <div class="data-card">
                    <div class="data-card-header">Detalhamento de Vendas</div>
                    <div class="table-responsive">
                        <table id="table-reports">
                            <thead><tr><th>Data</th><th>Cliente</th><th>Origem</th><th>Vendedor</th><th>Produto/Servi√ßo</th><th>Valor</th><th>Margem</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ABA EQUIPA -->
            <section id="tab-equipe" class="tab-content">
                <button onclick="APP.prepareUser()" class="btn btn-main admin-only" style="margin-bottom:15px;">+ Novo Membro</button>
                <div class="data-card">
                    <table id="table-users">
                        <thead><tr><th>Nome</th><th>Fun√ß√£o</th><th>Meta (M√™s)</th><th>A√ß√£o</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <!-- Modais -->
    <div id="modal-item" class="modal">
        <div class="modal-box">
            <h3>Gerenciar Estoque</h3>
            <form onsubmit="APP.saveStock(event)">
                <input type="hidden" id="stk-item-id-unique">
                <div class="form-item"><label>Tipo</label><select id="stk-type"><option>Trator</option><option>Implemento</option><option>Outros</option></select></div>
                <div class="form-item"><label>Modelo</label><input id="stk-model" required></div>
                <div class="form-item"><label>Chassi/S√©rie</label><input id="stk-mono"></div>
                <div class="form-item"><label>Custo (R$)</label><input id="stk-cost" required oninput="APP.maskMoney(this)"></div>
                <div class="form-item"><label>Data Entrada</label><input id="stk-date-display" disabled placeholder="Autom√°tico"></div>
                <button class="btn btn-main" style="width:100%">Salvar</button>
                <button type="button" onclick="APP.closeModals()" class="btn" style="width:100%; margin-top:5px">Cancelar</button>
            </form>
        </div>
    </div>

    <div id="modal-client" class="modal">
        <div class="modal-box">
            <h3>Novo Cliente</h3>
            <form onsubmit="APP.saveClient(event)">
                <input type="hidden" id="cli-id">
                <div class="form-item"><label>Nome Completo</label><input id="cli-name" required></div>
                <div class="form-item"><label>CPF / CNPJ</label><input id="cli-cpf" placeholder="000.000.000-00"></div>
                <div class="form-item"><label>Telefone (WhatsApp)</label><input id="cli-phone" oninput="APP.inputPhone(this)" placeholder="(00) 00000-0000"></div>
                <div class="form-item"><label>Email</label><input id="cli-email" type="email"></div>
                <div class="form-item"><label>Cidade / Obs</label><input id="cli-obs"></div>
                <div class="form-item"><label>Link Documentos (Drive/Nuvem)</label><input id="cli-docs" placeholder="Cole o link do Google Drive/Dropbox aqui"></div>
                <button class="btn btn-main" style="width:100%">Salvar</button>
                <button type="button" onclick="APP.closeModals()" class="btn" style="width:100%; margin-top:5px">Cancelar</button>
            </form>
        </div>
    </div>

    <div id="modal-history" class="modal">
        <div class="modal-box">
            <h3 id="hist-title">üìú Hist√≥rico</h3>
            <div id="history-content" style="margin-top:20px; max-height:300px; overflow-y:auto; padding-left:5px;"></div>
            <button type="button" onclick="APP.closeModals()" class="btn" style="width:100%; margin-top:20px">Fechar</button>
        </div>
    </div>

    <div id="modal-deal" class="modal">
        <div class="modal-box">
            <h3>Detalhes do Neg√≥cio</h3>
            <form onsubmit="APP.saveDeal(event)">
                <input type="hidden" id="deal-id">
                
                <!-- NOVO: Sele√ß√£o de Vendedor (Respons√°vel) -->
                <div class="form-item" id="div-deal-owner" style="display:none;">
                    <label>Respons√°vel (Vendedor)</label>
                    <select id="deal-owner" style="background:#fefce8; border-color:#f59e0b;"></select>
                </div>

                <div class="form-item">
                    <label>Cliente</label>
                    <input id="deal-client" list="list-clients" required placeholder="Digite ou selecione...">
                    <datalist id="list-clients"></datalist>
                </div>
                <div class="form-item">
                    <label>Origem do Lead</label>
                    <select id="deal-source">
                        <option value="Loja/Passante">Loja / Passante</option>
                        <option value="Indicacao">Indica√ß√£o</option>
                        <option value="Visita">Visita</option>
                        <option value="Instagram">Instagram / Facebook</option>
                        <option value="Google">Google / Site</option>
                        <option value="Feira">Feira / Evento</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div class="form-item"><label>Valor (R$)</label><input id="deal-value" required oninput="APP.maskMoney(this)"></div>
                <div class="form-item"><label>Tipo</label><select id="deal-type" onchange="APP.toggleStock()"><option value="maquina">M√°quina</option><option value="consorcio">Cons√≥rcio</option></select></div>
                <div class="form-item" id="div-stock-select"><label>Vincular M√°quina</label><select id="deal-stock"></select></div>
                <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                <h4 style="margin-bottom:10px; font-size:12px;">Agendar Pr√≥xima A√ß√£o</h4>
                <div class="form-item"><label>Data</label><input type="date" id="deal-next-date"></div>
                <div class="form-item"><label>Descri√ß√£o (O que fazer?)</label><input type="text" id="deal-next-desc" placeholder="Ex: Ligar, Visitar..."></div>
                <button class="btn btn-main" style="width:100%">Salvar</button>
                <button type="button" onclick="APP.closeModals()" class="btn" style="width:100%; margin-top:5px">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- MODAL USU√ÅRIO (COM CAMPO DE META) -->
    <div id="modal-user" class="modal">
        <div class="modal-box">
            <h3>Membro da Equipe</h3>
            <form onsubmit="APP.saveUser(event)">
                <input type="hidden" id="usr-id">
                <div class="form-item"><label>Nome</label><input id="usr-name" required></div>
                <div class="form-item"><label>Fun√ß√£o</label>
                    <select id="usr-role">
                        <option value="vendedor">Vendedor</option>
                        <option value="assistente">Assistente</option>
                        <option value="gestor">Gestor</option>
                    </select>
                </div>
                <!-- NOVO CAMPO: META -->
                <div class="form-item"><label>Meta Mensal (R$)</label><input id="usr-goal" oninput="APP.maskMoney(this)" placeholder="0,00"></div>
                <button class="btn btn-main" style="width:100%">Salvar</button>
                <button type="button" onclick="APP.closeModals()" class="btn" style="width:100%; margin-top:5px">Cancelar</button>
            </form>
        </div>
    </div>

    <div id="toast">Salvo com sucesso!</div>

    <script>
        /**
         * TRAIL SYSTEM - v3.9.22 (CLOUD - METAS & VENDAS)
         * Conectado ao Supabase (PostgreSQL)
         */

        // CREDENCIAIS DO SUPABASE
        const SUPABASE_URL = 'https://igvdhpzzjamoyetxickb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_mXmrR5peC1mICxxMxjDKrg_2NJUZG0Q'; // Chave fornecida

        // Inicializa o cliente Supabase
        let supabaseClient;

        if (window.supabase && window.supabase.createClient) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } else if (typeof createClient !== 'undefined') {
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
        } else {
            console.error("ERRO CR√çTICO: Biblioteca Supabase n√£o encontrada.");
            if (window.supabase) {
                try {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                } catch(e) { console.error(e); }
            }
        }

        const APP = {
            data: { stock: [], users: [], deals: [], clients: [] },
            user: null,
            dragId: null,

            init: async () => {
                if (!supabaseClient) {
                    alert("ERRO: N√£o foi poss√≠vel conectar ao banco de dados.");
                    return;
                }

                const [usersReq, clientsReq, stockReq, dealsReq] = await Promise.all([
                    supabaseClient.from('users').select('*'),
                    supabaseClient.from('clients').select('*'),
                    supabaseClient.from('stock').select('*'),
                    supabaseClient.from('deals').select('*')
                ]);

                if (usersReq.error) console.error("Erro Users:", usersReq.error);
                
                APP.data.users = usersReq.data || [];
                APP.data.clients = clientsReq.data || [];
                APP.data.stock = stockReq.data || [];
                APP.data.deals = dealsReq.data || [];

                if (APP.data.users.length === 0) {
                    await APP.ensureDefaultUser();
                }

                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                const startInput = document.getElementById('rep-start');
                const endInput = document.getElementById('rep-end');
                if(startInput) startInput.value = firstDay.toISOString().split('T')[0];
                if(endInput) endInput.value = lastDay.toISOString().split('T')[0];

                APP.renderUserSelect();
                APP.renderAll(); 
            },

            ensureDefaultUser: async () => {
                const defaultUser = {name: 'Gestor Inicial', role: 'gestor'}; 
                const { data, error } = await supabaseClient.from('users').insert(defaultUser).select();
                if (!error && data) {
                    APP.data.users.push(data[0]);
                } else {
                    APP.data.users.push(defaultUser);
                }
            },

            uuid: () => { return crypto.randomUUID(); },

            refreshLocal: (table, item, isDelete = false) => {
                if (isDelete) {
                    APP.data[table] = APP.data[table].filter(i => i.id !== item.id);
                } else {
                    const idx = APP.data[table].findIndex(i => i.id === item.id);
                    if (idx > -1) { APP.data[table][idx] = item; } else { APP.data[table].push(item); }
                }
                APP.renderAll();
            },

            addLog: (obj, action, detail) => {
                if(!obj.history) obj.history = [];
                obj.history.push({ date: Date.now(), user: APP.user ? APP.user.name : 'Sistema', action: action, detail: detail });
                return obj.history;
            },

            addHistory: async (stockId, action, detail) => {
                const item = APP.data.stock.find(s => s.id === stockId);
                if(!item) return;
                const newHistory = APP.addLog(item, action, detail);
                await supabaseClient.from('stock').update({ history: newHistory }).eq('id', stockId);
            },

            addDealHistory: async (dealId, action, detail) => {
                const item = APP.data.deals.find(d => d.id === dealId);
                if(!item) return;
                const newHistory = APP.addLog(item, action, detail);
                await supabaseClient.from('deals').update({ history: newHistory }).eq('id', dealId);
            },

            toggleMenu: () => {
                document.getElementById('sidebar').classList.toggle('open');
            },

            toast: (msg) => { 
                const t = document.getElementById('toast'); 
                t.innerText = msg; t.style.opacity = 1; setTimeout(()=>t.style.opacity=0, 3000); 
            },

            nav: (tab) => {
                document.getElementById('sidebar').classList.remove('open');
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                
                const tabEl = document.getElementById('tab-'+tab);
                const btnEl = document.getElementById('btn-'+tab);
                const titleEl = document.getElementById('page-title');

                if(tabEl) tabEl.classList.add('active');
                if(btnEl) btnEl.classList.add('active');
                if(titleEl) titleEl.innerText = tab.toUpperCase();
                
                if(tab === 'estoque') APP.renderStock();
                if(tab === 'funil') APP.renderKanban();
                if(tab === 'relatorios') APP.renderReports();
                if(tab === 'clientes') APP.renderClients();
                if(tab === 'agenda') APP.renderAgenda();
                if(tab === 'vendas') APP.renderCatalog(); 
                if(tab === 'dashboard') APP.renderGoals(); 
            },

            modal: (id) => document.getElementById(id).classList.add('active'),
            closeModals: () => { 
                document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); 
                document.querySelectorAll('form').forEach(f => f.reset()); 
            },

            login: (name) => {
                const user = APP.data.users.find(u => u.name === name);
                if (!user) return alert("Usu√°rio n√£o encontrado.");

                if (user.password) {
                    const input = prompt(`Ol√° ${user.name}, por favor digite sua senha:`);
                    if (input !== user.password) {
                        return alert("Senha incorreta!");
                    }
                }

                APP.user = user;
                document.getElementById('user-overlay').style.display = 'none';
                document.getElementById('user-info').innerText = APP.user.name;
                
                const isGestor = APP.user.role === 'gestor';
                const isAssistente = APP.user.role === 'assistente';
                const gestorBtns = document.querySelectorAll('.gestor-ctrl');
                const adminBtns = document.querySelectorAll('.admin-only');
                
                gestorBtns.forEach(btn => {
                    if (isGestor || isAssistente) {
                        btn.style.setProperty('display', 'inline-flex', 'important');
                        btn.classList.add('show-gestor');
                    } else {
                        btn.style.setProperty('display', 'none', 'important');
                        btn.classList.remove('show-gestor');
                    }
                });

                adminBtns.forEach(btn => {
                    if (isGestor) {
                        btn.style.setProperty('display', 'inline-flex', 'important');
                    } else {
                        btn.style.setProperty('display', 'none', 'important');
                    }
                });
                
                const filter = document.getElementById('filter-user');
                const sellerFilter = document.getElementById('rep-seller'); 

                if(isGestor || isAssistente) {
                    filter.style.display = 'block';
                    filter.innerHTML = '<option value="all">Ver Todos</option>';
                    sellerFilter.innerHTML = '<option value="all">Todos</option>'; 
                    
                    APP.data.users.forEach(u => {
                        const opt = `<option value="${u.name}">${u.name}</option>`;
                        filter.innerHTML += opt;
                        sellerFilter.innerHTML += opt;
                    });
                } else { 
                    filter.style.display = 'none'; 
                }
                
                APP.renderAll();
            },

            logout: () => { 
                document.getElementById('user-overlay').style.display = 'flex'; 
                APP.user = null; 
            },

            // FUN√á√ÉO PARA PREPARAR CRIA√á√ÉO DE USU√ÅRIO
            prepareUser: () => {
                document.getElementById('usr-id').value = '';
                document.getElementById('usr-name').value = '';
                document.getElementById('usr-role').value = 'vendedor';
                document.getElementById('usr-goal').value = '';
                APP.modal('modal-user');
            },

            // FUN√á√ÉO PARA PREPARAR EDI√á√ÉO DE USU√ÅRIO
            editUser: (id) => {
                const u = APP.data.users.find(x => x.id === id);
                if(!u) return;
                
                document.getElementById('usr-id').value = u.id;
                document.getElementById('usr-name').value = u.name;
                document.getElementById('usr-role').value = u.role;
                document.getElementById('usr-goal').value = u.goal ? u.goal.toLocaleString('pt-BR', {minimumFractionDigits:2}) : '';
                
                APP.modal('modal-user');
            },

            saveUser: async (e) => {
                e.preventDefault();
                
                if (APP.user.role !== 'gestor') {
                    return alert("Acesso negado: Apenas gestores podem gerenciar membros.");
                }

                const id = document.getElementById('usr-id').value;
                
                const userData = { 
                    name: document.getElementById('usr-name').value, 
                    role: document.getElementById('usr-role').value,
                    goal: APP.parseMoney(document.getElementById('usr-goal').value)
                };

                let pwd = null;
                if (!id) {
                    // Novo Usu√°rio: Pedir senha obrigat√≥ria ou opcional
                    pwd = prompt("Defina uma senha para este usu√°rio (Opcional - Deixe em branco para sem senha):");
                    userData.password = pwd || null;
                    
                    const { data, error } = await supabaseClient.from('users').insert(userData).select();
                    if(error) return alert("Erro ao criar usu√°rio: " + error.message);
                    APP.refreshLocal('users', data[0]);
                    
                } else {
                    // Edi√ß√£o: Mant√©m a senha existente (n√£o pergunta nada)
                    const { data, error } = await supabaseClient.from('users').update(userData).eq('id', id).select();
                    if(error) return alert("Erro ao atualizar usu√°rio: " + error.message);
                    APP.refreshLocal('users', data[0]);
                }
                
                APP.closeModals();
                APP.toast('Usu√°rio salvo!');
            },

            renderUserSelect: () => { 
                document.getElementById('user-list-grid').innerHTML = APP.data.users.map(u => `<div class="user-select-card" onclick="APP.login('${u.name}')"><div style="font-weight:900;">${u.name}</div><div style="font-size:10px; color:#9ca3af; text-transform:uppercase;">${u.role}</div></div>`).join(''); 
            },

            renderUsers: () => {
                const isGestor = APP.user && APP.user.role === 'gestor';

                document.querySelector('#table-users tbody').innerHTML = APP.data.users.map(u => {
                    let actionBtns = '';
                    if (isGestor) {
                        actionBtns = `
                            <button class="btn btn-small btn-main" onclick="APP.editUser(${u.id})">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-danger" onclick="APP.deleteUser(${u.id})">√ó</button>
                        `;
                    }
                    
                    const goalDisplay = u.goal ? u.goal.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : '-';
                    return `<tr><td>${u.name}</td><td>${u.role}</td><td>${goalDisplay}</td><td>${actionBtns}</td></tr>`;
                }).join('');
                
                const tbPerf = document.querySelector('#table-performance tbody');
                let ranking = [];

                tbPerf.innerHTML = APP.data.users.map(u => {
                    const userDeals = APP.data.deals.filter(d => d.owner === u.name);
                    const open = userDeals.filter(d => d.stage !== 'ganho' && d.stage !== 'perdido').length;
                    const wonDeals = userDeals.filter(d => d.stage === 'ganho');
                    const wonCount = wonDeals.length;
                    const totalSales = wonDeals.reduce((a, b) => a + b.value, 0);
                    const totalDeals = userDeals.length;
                    const conversion = totalDeals > 0 ? ((wonCount / totalDeals) * 100).toFixed(1) : '0.0';

                    if (u.role !== 'gestor') {
                        ranking.push({name: u.name, total: totalSales});
                    }

                    return `<tr><td>${u.name}</td><td>${open}</td><td>${wonCount}</td><td><b>${conversion}%</b></td><td>${totalDeals}</td></tr>`;
                }).join('');

                ranking.sort((a,b) => b.total - a.total);
                document.getElementById('ranking-list').innerHTML = ranking.map((r, i) => `
                    <div class="ranking-row">
                        <div style="display:flex; align-items:center;">
                            <div class="ranking-pos">${i+1}</div>
                            <div class="ranking-name">${r.name}</div>
                        </div>
                        <div class="ranking-val">${r.total.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div>
                    </div>
                `).join('');
            },

            renderGoals: () => {
                const container = document.getElementById('goals-container');
                if(!container) return;

                const sellers = APP.data.users.filter(u => u.role === 'vendedor' && u.goal > 0);
                
                if (sellers.length === 0) {
                    container.innerHTML = '<div style="color:#6b7280; font-size:12px;">Nenhuma meta definida. Cadastre uma meta para os vendedores na aba "Equipe".</div>';
                    return;
                }

                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                let html = '';
                sellers.forEach(u => {
                    const currentSales = APP.data.deals
                        .filter(d => {
                            if (d.owner !== u.name || d.stage !== 'ganho') return false;
                            const dDate = new Date(d.close_date || d.created_at); 
                            return dDate.getMonth() === currentMonth && dDate.getFullYear() === currentYear;
                        })
                        .reduce((acc, curr) => acc + curr.value, 0);

                    const pct = Math.min((currentSales / u.goal) * 100, 100); 
                    let color = '#ef4444'; 
                    if (pct > 50) color = '#eab308'; 
                    if (pct >= 100) color = '#10b981'; 

                    html += `
                        <div style="border:1px solid #e5e7eb; border-radius:8px; padding:10px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <span style="font-weight:bold; font-size:12px;">${u.name}</span>
                                <span style="font-size:11px; color:#6b7280;">${pct.toFixed(0)}%</span>
                            </div>
                            <div style="background:#f3f4f6; height:8px; border-radius:4px; overflow:hidden;">
                                <div style="width:${pct}%; background:${color}; height:100%;"></div>
                            </div>
                            <div style="font-size:10px; margin-top:5px; color:#6b7280;">
                                ${currentSales.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})} / ${u.goal.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            },

            // NOVA FUN√á√ÉO: RENDERIZAR O CAT√ÅLOGO
            renderCatalog: () => {
                if (!APP.user) return; 

                const tbody = document.querySelector('#table-catalog tbody');
                const thead = document.querySelector('#table-catalog thead');
                if(!tbody || !thead) return;

                const term = document.getElementById('search-catalog') ? document.getElementById('search-catalog').value.toLowerCase() : '';
                
                const isGestor = APP.user.role === 'gestor';
                const isAssistente = APP.user.role === 'assistente';
                const canEdit = isGestor || isAssistente;

                // Define cabe√ßalhos
                if (canEdit) {
                    thead.innerHTML = `<tr><th>Modelo</th><th>Status</th><th>Custo (R$)</th><th style="width:140px">Pre√ßo Venda (R$)</th><th style="width:140px">Pre√ßo Promo (R$)</th><th>Margem Est.</th></tr>`;
                } else {
                    thead.innerHTML = `<tr><th>Modelo</th><th>Status</th><th>Pre√ßo</th></tr>`;
                }

                let items = APP.data.stock.filter(s => s.status !== 'Vendido'); 
                items.sort((a,b) => a.model.localeCompare(b.model));

                let html = '';
                items.forEach(s => {
                    if (term && !s.model.toLowerCase().includes(term)) return;

                    const cost = s.cost || 0;
                    const sale = s.sale_price || 0;
                    const promo = s.promo_price || 0;
                    
                    let statusBadgeClass = 'badge-success';
                    if (s.status === 'Reservado') statusBadgeClass = 'badge-warning';

                    if (canEdit) {
                        // C√°lculo da margem para o gestor
                        // Se houver pre√ßo promocional, usa ele para o calculo da margem exibida, sen√£o usa o pre√ßo normal
                        const activePrice = promo > 0 ? promo : sale;
                        const marginVal = activePrice - cost;
                        const marginColor = marginVal >= 0 ? '#10b981' : '#ef4444';
                        
                        html += `
                            <tr>
                                <td><b>${s.model}</b><br><small style="color:#9ca3af">${s.mono || ''}</small></td>
                                <td><span class="badge ${statusBadgeClass}">${s.status}</span></td>
                                <td style="color:#6b7280;">${cost.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                <td>
                                    <input type="text" 
                                        value="${sale > 0 ? (sale/100*100).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : ''}" 
                                        oninput="APP.maskMoney(this); APP.calcMarginDisplay(this, '${s.id}', ${cost}, 'sale')" 
                                        onchange="APP.saveCatalogPrice('${s.id}', 'sale_price', this.value)"
                                        placeholder="0,00"
                                        style="width:100%; padding:6px; border:1px solid #d1d5db; border-radius:4px; font-weight:bold;">
                                </td>
                                <td>
                                    <input type="text" 
                                        value="${promo > 0 ? (promo/100*100).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : ''}" 
                                        oninput="APP.maskMoney(this); APP.calcMarginDisplay(this, '${s.id}', ${cost}, 'promo')" 
                                        onchange="APP.saveCatalogPrice('${s.id}', 'promo_price', this.value)"
                                        placeholder="Promo√ß√£o..."
                                        style="width:100%; padding:6px; border:1px solid #fca5a5; border-radius:4px; color:#b91c1c; font-weight:bold;">
                                </td>
                                <td id="margin-${s.id}" style="color:${marginColor}; font-weight:900;">
                                    ${marginVal.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}
                                </td>
                            </tr>
                        `;
                    } else {
                        // Vis√£o do Vendedor
                        let priceDisplay = '';
                        if (promo > 0) {
                            priceDisplay = `
                                <div style="text-decoration: line-through; color: #9ca3af; font-size: 10px;">De: ${sale.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div>
                                <div style="color: #ef4444; font-weight: 900; font-size: 14px;">Por: ${promo.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div>
                            `;
                        } else if (sale > 0) {
                            priceDisplay = `<div style="font-weight: 900; font-size: 14px; color: #111827;">${sale.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div>`;
                        } else {
                            priceDisplay = `<span style="color:#9ca3af; font-style:italic;">Sob Consulta</span>`;
                        }

                        html += `
                            <tr>
                                <td><b>${s.model}</b><br><small style="color:#9ca3af">${s.mono || ''}</small></td>
                                <td><span class="badge ${statusBadgeClass}">${s.status}</span></td>
                                <td>${priceDisplay}</td>
                            </tr>
                        `;
                    }
                });

                if (!html) html = `<tr><td colspan="${canEdit ? 6 : 3}" style="text-align:center; padding:20px; color:#9ca3af">Nenhum item no cat√°logo.</td></tr>`;
                tbody.innerHTML = html;
            },

            // ATUALIZAR PRE√áO NO BANCO (GEST√ÉO DE PRE√áOS)
            saveCatalogPrice: async (id, field, value) => {
                const valNum = APP.parseMoney(value);
                
                // Atualiza localmente para refletir sem refresh
                const itemIndex = APP.data.stock.findIndex(s => s.id === id);
                if (itemIndex > -1) {
                    APP.data.stock[itemIndex][field] = valNum;
                }

                // Atualiza no banco
                const { error } = await supabaseClient.from('stock').update({ [field]: valNum }).eq('id', id);
                
                if (error) {
                    // Fallback para erro caso a coluna n√£o exista ainda
                    console.error("Erro ao salvar pre√ßo:", error);
                    alert("Aten√ß√£o: N√£o foi poss√≠vel salvar. Verifique se as colunas 'sale_price' e 'promo_price' foram criadas no banco de dados.");
                } else {
                    APP.toast("Pre√ßo atualizado!");
                }
            },

            // CALCULAR MARGEM VISUALMENTE (DURANTE A DIGITA√á√ÉO)
            calcMarginDisplay: (input, id, cost, type) => {
                const val = APP.parseMoney(input.value);
                const item = APP.data.stock.find(s => s.id === id);
                if (!item) return;

                // Pega o outro valor (se estou editando sale, pego promo atual e vice-versa) para saber qual √© o "ativo"
                let sale = type === 'sale' ? val : (item.sale_price || 0);
                let promo = type === 'promo' ? val : (item.promo_price || 0);

                // Regra: Se tem promo > 0, a margem √© sobre a promo
                const activePrice = promo > 0 ? promo : sale;
                const margin = activePrice - cost;
                
                const el = document.getElementById('margin-'+id);
                if (el) {
                    el.innerText = margin.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                    el.style.color = margin >= 0 ? '#10b981' : '#ef4444';
                }
            },

            deleteUser: async (id) => {
                if (APP.user.role !== 'gestor') {
                    return alert("Acesso negado: Apenas gestores podem remover membros.");
                }

                if(confirm('Excluir usu√°rio?')) {
                    const { error } = await supabaseClient.from('users').delete().eq('id', id);
                    if(error) return alert("Erro: " + error.message);
                    APP.data.users = APP.data.users.filter(u => u.id !== id);
                    APP.renderUsers();
                    APP.renderUserSelect();
                }
            },

            saveClient: async (e) => {
                e.preventDefault();
                const id = document.getElementById('cli-id').value;
                const cliData = {
                    name: document.getElementById('cli-name').value,
                    phone: document.getElementById('cli-phone').value,
                    email: document.getElementById('cli-email').value,
                    obs: document.getElementById('cli-obs').value,
                    cpf_cnpj: document.getElementById('cli-cpf').value, 
                    doc_link: document.getElementById('cli-docs').value 
                };
                if (id) cliData.id = id;
                const { data, error } = await supabaseClient.from('clients').upsert(cliData).select();
                if(error) return alert("Erro: " + error.message);
                APP.refreshLocal('clients', data[0]);
                APP.closeModals(); 
            },
            
            deleteClient: async (id) => {
                if(confirm('Excluir cliente?')) { 
                    const { error } = await supabaseClient.from('clients').delete().eq('id', id);
                    if(error) return alert("Erro: " + error.message);
                    APP.refreshLocal('clients', {id}, true);
                }
            },

            editClient: (id) => {
                const c = APP.data.clients.find(x => x.id === id);
                if(!c) return;
                document.getElementById('cli-id').value = c.id;
                document.getElementById('cli-name').value = c.name;
                document.getElementById('cli-phone').value = c.phone;
                document.getElementById('cli-email').value = c.email;
                document.getElementById('cli-obs').value = c.obs;
                document.getElementById('cli-cpf').value = c.cpf_cnpj || '';
                document.getElementById('cli-docs').value = c.doc_link || '';
                APP.modal('modal-client');
            },

            renderClients: () => {
                const term = document.getElementById('search-client').value.toLowerCase();
                const tbody = document.querySelector('#table-clients tbody');
                if(!tbody) return;
                const filtered = APP.data.clients.filter(c => c.name.toLowerCase().includes(term));
                
                tbody.innerHTML = filtered.map(c => {
                    const totalSpent = APP.data.deals
                        .filter(d => d.client === c.name && d.stage === 'ganho')
                        .reduce((acc, curr) => acc + curr.value, 0);

                    let docHtml = '-';
                    if (c.doc_link) {
                        docHtml = `<a href="${c.doc_link}" target="_blank" class="btn btn-small btn-dark" title="Abrir Documentos">üìÇ Abrir</a>`;
                    }

                    return `
                    <tr>
                        <td>
                            <b>${c.name}</b><br>
                            <small style="color:#6b7280">${c.cpf_cnpj || 'Sem CPF/CNPJ'}</small>
                        </td>
                        <td>
                            <div style="font-size:12px">${c.phone || '-'}</div>
                            ${c.phone ? `<a href="#" onclick="APP.openWhatsapp('${c.phone}')" class="btn-whatsapp">Zap</a>` : ''}
                            <div style="font-size:10px; color:#6b7280; margin-top:2px;">${c.email || ''}</div>
                        </td>
                        <td>${c.obs || '-'}</td>
                        <td>
                            <span style="color:#059669; font-weight:800;">
                                ${totalSpent.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}
                            </span>
                        </td>
                        <td>${docHtml}</td>
                        <td>
                            <button onclick="APP.editClient('${c.id}')" class="btn btn-small btn-main">‚úèÔ∏è</button>
                            <button onclick="APP.deleteClient('${c.id}')" class="btn btn-small btn-danger">√ó</button>
                        </td>
                    </tr>
                    `;
                }).join('');
            },

            importStock: (e) => {
                if(APP.user.role !== 'gestor') return alert('Acesso negado');
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.readAsText(file, 'ISO-8859-1');
                reader.onload = async (evt) => {
                    const text = evt.target.result;
                    const lines = text.split('\n');
                    let count = 0;
                    const newItems = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        const cols = line.split(';');
                        if (cols.length >= 4) {
                            const model = cols[1];
                            const costStr = cols[3];
                            const dateStr = cols[4];
                            if (model && model !== 'N/A') {
                                let dbDate = new Date().toISOString(); 
                                if(dateStr) {
                                    const parts = dateStr.trim().split('/');
                                    if(parts.length === 3) dbDate = new Date(parts[2], parts[1]-1, parts[0]).toISOString();
                                }
                                newItems.push({
                                    type: cols[0], model: model, mono: cols[2],
                                    cost: APP.parseMoney(costStr), date_entry: dbDate,
                                    status: 'Dispon√≠vel', history: [{date: Date.now(), user: APP.user.name, action: 'Importa√ß√£o', detail: 'Via CSV'}]
                                });
                                count++;
                            }
                        }
                    }
                    if(newItems.length > 0) {
                        const { data, error } = await supabaseClient.from('stock').insert(newItems).select();
                        if(error) alert("Erro: " + error.message);
                        else { APP.data.stock.push(...data); APP.toast(`${count} itens importados!`); APP.renderStock(); }
                    }
                    e.target.value = '';
                };
            },

            saveStock: async (e) => {
                e.preventDefault();
                if(APP.user.role !== 'gestor' && APP.user.role !== 'assistente') return alert('Acesso negado.');
                const id = document.getElementById('stk-item-id-unique').value; 
                const itemData = {
                    type: document.getElementById('stk-type').value,
                    model: document.getElementById('stk-model').value,
                    mono: document.getElementById('stk-mono').value,
                    cost: APP.parseMoney(document.getElementById('stk-cost').value)
                };
                if (id) {
                    itemData.id = id;
                    APP.addHistory(id, 'Edi√ß√£o', 'Dados atualizados'); 
                    const { data, error } = await supabaseClient.from('stock').update(itemData).eq('id', id).select();
                    if(!error) APP.refreshLocal('stock', data[0]);
                } else {
                    itemData.status = 'Dispon√≠vel';
                    itemData.date_entry = new Date().toISOString();
                    itemData.history = [{date: Date.now(), user: APP.user.name, action: 'Cria√ß√£o', detail: 'Manual'}];
                    const { data, error } = await supabaseClient.from('stock').insert(itemData).select();
                    if(error) return alert("Erro: " + error.message);
                    APP.refreshLocal('stock', data[0]);
                }
                APP.closeModals();
            },

            prepareStock: () => {
                document.getElementById('stk-item-id-unique').value = ''; 
                document.getElementById('stk-model').value = '';
                document.getElementById('stk-mono').value = '';
                document.getElementById('stk-cost').value = '';
                document.getElementById('stk-date-display').value = '';
                document.getElementById('stk-type').selectedIndex = 0;
                APP.modal('modal-item');
            },

            restoreStock: async (id) => {
                if(APP.user.role !== 'gestor') return alert('Acesso negado');
                if(confirm('Restaurar para Dispon√≠vel?')) {
                    const item = APP.data.stock.find(s => s.id === id);
                    if(item) {
                        const deal = APP.data.deals.find(d => d.stock_id === id && d.stage === 'ganho');
                        if(deal) {
                            await supabaseClient.from('deals').update({stock_id: null}).eq('id', deal.id);
                            APP.addDealHistory(deal.id, 'Desvinculo', 'Item restaurado ao estoque.');
                            deal.stock_id = null; 
                        }
                        item.status = 'Dispon√≠vel';
                        APP.addLog(item, 'Restaura√ß√£o', 'Manual'); 
                        const { error } = await supabaseClient.from('stock').update({status: 'Dispon√≠vel', history: item.history}).eq('id', id);
                        if(!error) { APP.toast('Item restaurado!'); APP.renderStock(); }
                    }
                }
            },

            deleteStock: async (id) => { 
                if(APP.user.role !== 'gestor') return alert('Acesso negado');
                if(confirm('Excluir permanentemente?')) { 
                    const { error } = await supabaseClient.from('stock').delete().eq('id', id);
                    if(error) return alert("Erro: " + error.message);
                    APP.refreshLocal('stock', {id}, true);
                } 
            },

            editStock: (id) => { 
                const s = APP.data.stock.find(x => x.id === id); 
                document.getElementById('stk-item-id-unique').value = s.id; 
                document.getElementById('stk-model').value = s.model; 
                document.getElementById('stk-mono').value = s.mono;
                document.getElementById('stk-cost').value = s.cost.toLocaleString('pt-BR', {minimumFractionDigits: 2}); 
                APP.modal('modal-item'); 
            },
            
            toggleStock: () => document.getElementById('div-stock-select').style.display = document.getElementById('deal-type').value === 'consorcio' ? 'none' : 'block',

            renderStock: () => {
                if (!APP.user) return; // FIX: Previne erro ao iniciar sem utilizador

                const term = document.getElementById('search-stock').value.toLowerCase();
                const tbody = document.querySelector('#table-stock tbody');
                const tbodySold = document.querySelector('#table-stock-sold tbody');
                let htmlBuffer = ''; let htmlSold = '';
                const isGestor = APP.user.role === 'gestor';
                const isAssistente = APP.user.role === 'assistente';

                APP.data.stock.forEach(s => {
                    if (s.model.toLowerCase().includes(term) || (s.mono && s.mono.toLowerCase().includes(term))) {
                        const entryDate = s.date_entry ? new Date(s.date_entry).getTime() : Date.now();
                        if (s.status !== 'Vendido') {
                            const days = APP.daysDiff(entryDate);
                            let giroStyle = 'background:#d1fae5; color:#065f46'; let giroLabel = 'Saud√°vel';
                            if (days > 365) { giroLabel = 'URGENTE'; giroStyle = 'background:#450a0a; color:#fecaca; font-weight:900;'; } 
                            else if (days > 210) { giroLabel = 'Cr√≠tico'; giroStyle = 'background:#fee2e2; color:#991b1b; font-weight:bold;'; } 
                            else if (days > 150) { giroLabel = 'Lento'; giroStyle = 'background:#ffedd5; color:#ea580c;'; } 
                            else if (days > 90) { giroLabel = 'Aten√ß√£o'; giroStyle = 'background:#fef3c7; color:#b45309;'; }
                            
                            let statusBadgeClass = 'badge-success';
                            if (s.status === 'Reservado') statusBadgeClass = 'badge-warning';
                            
                            let actionHtml = '';
                            if(isGestor) {
                                actionHtml = `<button onclick="APP.editStock('${s.id}')" title="Editar" class="btn btn-small btn-main">‚úèÔ∏è</button> <button onclick="APP.viewHistory('${s.id}', 'stock')" title="Hist√≥rico" class="btn btn-small btn-dark">üìú</button> <button onclick="APP.deleteStock('${s.id}')" title="Excluir" class="btn btn-small btn-danger">√ó</button>`;
                            } else if (isAssistente) {
                                actionHtml = `<button onclick="APP.editStock('${s.id}')" title="Editar" class="btn btn-small btn-main">‚úèÔ∏è</button> <button onclick="APP.viewHistory('${s.id}', 'stock')" title="Hist√≥rico" class="btn btn-small btn-dark">üìú</button>`;
                            } else {
                                actionHtml = `<button onclick="APP.viewHistory('${s.id}', 'stock')" title="Hist√≥rico" class="btn btn-small btn-dark">üìú Detalhes</button>`;
                            }
                            htmlBuffer += `<tr><td>${s.type}</td><td><b>${s.model}</b></td><td>${s.mono || '-'}</td><td>${s.cost.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td><td>${days} dias</td><td><span style="padding:3px 6px; border-radius:4px; font-size:10px; ${giroStyle}">${giroLabel}</span></td><td><span class="badge ${statusBadgeClass}">${s.status}</span></td><td>${actionHtml}</td></tr>`;
                        } else {
                            let restoreBtn = '';
                            if(isGestor) { restoreBtn = `<button onclick="APP.restoreStock('${s.id}')" title="Restaurar para Dispon√≠vel" class="btn btn-small btn-dark">‚ôªÔ∏è Restaurar</button>`; }
                            const deal = APP.data.deals.find(d => d.stock_id === s.id && d.stage === 'ganho');
                            const cliente = deal ? deal.client : '<span style="color:#9ca3af">Desconhecido</span>';
                            const dataVenda = deal && deal.close_date ? new Date(deal.close_date).toLocaleDateString('pt-BR') : '-';
                            htmlSold += `<tr><td>${dataVenda}</td><td><b>${s.model}</b></td><td>${s.mono || '-'}</td><td>${s.cost.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td><td>${cliente}</td><td>${restoreBtn}</td></tr>`;
                        }
                    }
                });
                tbody.innerHTML = htmlBuffer;
                if(tbodySold) tbodySold.innerHTML = htmlSold || '<tr><td colspan="6" style="text-align:center; padding:15px; color:#9ca3af;">Nenhum item vendido ou arquivado.</td></tr>';
            },

            prepareDeal: (preselectedStockId = null) => {
                document.getElementById('deal-id').value = '';
                const sel = document.getElementById('deal-stock'); sel.innerHTML = '<option value="">Sem M√°quina</option>';
                APP.data.stock.filter(s => s.status !== 'Vendido').forEach(s => { const selected = preselectedStockId === s.id ? 'selected' : ''; sel.innerHTML += `<option value="${s.id}" ${selected}>${s.model} - R$ ${s.cost}</option>`; });
                const dl = document.getElementById('list-clients');
                dl.innerHTML = APP.data.clients.map(c => `<option value="${c.name}">`).join('');
                
                // --- NOVA L√ìGICA DE SELE√á√ÉO DE VENDEDOR ---
                const isGestorOrAssistente = ['gestor', 'assistente'].includes(APP.user.role);
                const ownerSelect = document.getElementById('deal-owner');
                const ownerDiv = document.getElementById('div-deal-owner');

                if (isGestorOrAssistente) {
                    ownerDiv.style.display = 'block';
                    // Lista todos os usu√°rios, mas pode filtrar por role='vendedor' se preferir
                    ownerSelect.innerHTML = APP.data.users
                        .map(u => `<option value="${u.name}" ${u.name === APP.user.name ? 'selected' : ''}>${u.name}</option>`)
                        .join('');
                } else {
                    ownerDiv.style.display = 'none';
                    ownerSelect.innerHTML = `<option value="${APP.user.name}" selected>${APP.user.name}</option>`;
                }
                // --- FIM DA NOVA L√ìGICA ---

                APP.modal('modal-deal');
            },

            saveDeal: async (e) => {
                e.preventDefault();
                const id = document.getElementById('deal-id').value;
                const stockId = document.getElementById('deal-stock').value || null; 
                
                // --- L√ä O DONO SELECIONADO OU USA O PADR√ÉO ---
                const selectedOwner = document.getElementById('deal-owner').value;
                const finalOwner = selectedOwner || APP.user.name;

                const dealData = {
                    client: document.getElementById('deal-client').value,
                    source: document.getElementById('deal-source').value,
                    value: APP.parseMoney(document.getElementById('deal-value').value),
                    stock_id: stockId,
                    next_date: document.getElementById('deal-next-date').value || null,
                    next_desc: document.getElementById('deal-next-desc').value,
                    owner: finalOwner // Usa o dono selecionado
                };

                if (id) {
                    dealData.id = id;
                    const oldDeal = APP.data.deals.find(d => d.id === id);
                    if(oldDeal && oldDeal.stage === 'ganho' && dealData.stock_id !== oldDeal.stock_id) {
                        if(dealData.stock_id) {
                            const s = APP.data.stock.find(x => x.id === dealData.stock_id);
                            if(s) dealData.original_cost = s.cost;
                        } else {
                            dealData.original_cost = 0;
                        }
                    }
                    if(!oldDeal.history) oldDeal.history = [];
                    let newHist = oldDeal.history;
                    if (dealData.next_date && (dealData.next_date !== oldDeal.next_date || dealData.next_desc !== oldDeal.next_desc)) {
                        const dateBr = dealData.next_date.split('-').reverse().join('/');
                        newHist.push({date: Date.now(), user: APP.user.name, action: 'Agenda', detail: `Nova a√ß√£o: ${dateBr} - ${dealData.next_desc}`});
                    }
                    dealData.history = newHist;
                    const { data, error } = await supabaseClient.from('deals').update(dealData).eq('id', id).select();
                    if(error) return alert("Erro: " + error.message);
                    APP.refreshLocal('deals', data[0]);
                } else {
                    dealData.stage = 'prospeccao';
                    dealData.history = [{date: Date.now(), user: APP.user.name, action: 'Cria√ß√£o', detail: 'Oportunidade criada'}];
                    if(dealData.next_date) {
                        const dateBr = dealData.next_date.split('-').reverse().join('/');
                        dealData.history.push({date: Date.now(), user: APP.user.name, action: 'Agenda', detail: `Inicial: ${dateBr} - ${dealData.next_desc}`});
                    }
                    const { data, error } = await supabaseClient.from('deals').insert(dealData).select();
                    if(error) return alert("Erro: " + error.message);
                    APP.refreshLocal('deals', data[0]);
                }
                
                if(stockId) {
                    const s = APP.data.stock.find(x => x.id === stockId);
                    if(s && s.status !== 'Reservado' && s.status !== 'Vendido') {
                        const newHist = APP.addLog(s, 'Reservado', `Vinculado ao cliente ${dealData.client}`);
                        await supabaseClient.from('stock').update({status: 'Reservado', history: newHist}).eq('id', stockId);
                        s.status = 'Reservado'; 
                    }
                }
                APP.closeModals(); APP.nav('funil');
            },

            editDeal: (id) => { 
                const d = APP.data.deals.find(x => x.id === id); 
                if (!d) return; 
                APP.prepareDeal(d.stock_id); 
                
                // Preenche os dados normais
                document.getElementById('deal-id').value = d.id; 
                document.getElementById('deal-client').value = d.client; 
                document.getElementById('deal-source').value = d.source || 'Loja/Passante';
                document.getElementById('deal-value').value = d.value.toLocaleString('pt-BR', {minimumFractionDigits:2}); 
                document.getElementById('deal-type').value = d.stock_id ? 'maquina' : 'consorcio'; 
                document.getElementById('deal-next-date').value = d.next_date || ''; 
                document.getElementById('deal-next-desc').value = d.next_desc || ''; 
                
                // Define o dono correto no select (para gestores/assistentes editarem)
                const ownerSelect = document.getElementById('deal-owner');
                if (ownerSelect) {
                    ownerSelect.value = d.owner;
                }

                APP.toggleStock();
            },

            deleteDeal: async (id) => {
                if (APP.user.role !== 'gestor') { 
                     return alert('Acesso negado: Apenas gestores podem excluir neg√≥cios.');
                }

                if(confirm('Excluir oportunidade?')) {
                    const deal = APP.data.deals.find(d => d.id === id);
                    const { error } = await supabaseClient.from('deals').delete().eq('id', id);
                    if(error) return alert("Erro: " + error.message);
                    if(deal && deal.stock_id) {
                        const s = APP.data.stock.find(x => x.id === deal.stock_id);
                        if(s && s.status === 'Reservado') {
                            const newHist = APP.addLog(s, 'Libera√ß√£o', 'Oportunidade exclu√≠da');
                            await supabaseClient.from('stock').update({status: 'Dispon√≠vel', history: newHist}).eq('id', s.id);
                            s.status = 'Dispon√≠vel';
                        }
                    }
                    APP.refreshLocal('deals', {id}, true);
                    APP.toast('Oportunidade exclu√≠da!');
                }
            },

            updateStage: async (id, stage) => {
                const deal = APP.data.deals.find(d => d.id === id);
                if (!deal) return;
                const oldStage = deal.stage;
                let motivoPerda = '';
                let updates = { stage: stage };
                if (stage === 'perdido') {
                    motivoPerda = prompt("Motivo da perda?");
                    if (motivoPerda === null) { APP.renderKanban(); return; }
                    if (!motivoPerda) motivoPerda = 'N√£o informado';
                    updates.next_desc = `‚õî PERDA: ${motivoPerda}`;
                    updates.next_date = new Date().toISOString().split('T')[0];
                }
                if (stage === 'ganho' && oldStage !== 'ganho') {
                    updates.close_date = new Date().toISOString();
                    if (deal.stock_id) {
                        const s = APP.data.stock.find(x => x.id === deal.stock_id);
                        if (s) updates.original_cost = s.cost;
                    } else {
                        updates.original_cost = 0;
                    }
                }
                let newHistory = APP.addLog(deal, 'Movimenta√ß√£o', `De ${oldStage.toUpperCase()} para ${stage.toUpperCase()}` + (motivoPerda ? ` (${motivoPerda})` : ''));
                updates.history = newHistory;
                const { error } = await supabaseClient.from('deals').update(updates).eq('id', id);
                if(error) return alert("Erro: " + error.message);
                Object.assign(deal, updates);
                if (deal.stock_id) {
                    const s = APP.data.stock.find(x => x.id === deal.stock_id);
                    if (s) {
                        let sUpdates = {}; let sAction = '';
                        if (stage === 'ganho') { sUpdates.status = 'Vendido'; sAction = 'Venda'; } 
                        else if (stage === 'perdido') { sUpdates.status = 'Dispon√≠vel'; sAction = 'Perda'; } 
                        else { if(s.status !== 'Reservado') { sUpdates.status = 'Reservado'; sAction = 'Reserva'; } }
                        if(sAction) {
                            s.status = sUpdates.status;
                            sUpdates.history = APP.addLog(s, sAction, `Neg√≥cio: ${deal.client}`);
                            await supabaseClient.from('stock').update(sUpdates).eq('id', s.id);
                        }
                    }
                }
                APP.renderAll();
            },

            renderKanban: () => {
                if (!APP.user) return; // FIX: Previne erro ao iniciar sem utilizador

                const cols = [{id:'prospeccao', l:'Prospec√ß√£o', c:'#3b82f6'},{id:'analise_credito', l:'An√°lise Cr√©dito', c:'#0ea5e9'},{id:'documentacao', l:'Documenta√ß√£o', c:'#eab308'},{id:'contrato', l:'Contrato', c:'#f97316'},{id:'af', l:'A.F.', c:'#8b5cf6'},{id:'ganho', l:'Ganho', c:'#10b981'},{id:'perdido', l:'Perdido', c:'#374151'}];
                const container = document.getElementById('kanban-board');
                container.innerHTML = '';
                let deals = APP.data.deals;
                const isGestor = APP.user.role === 'gestor';
                const isAssistente = APP.user.role === 'assistente';

                if (isGestor || isAssistente) { 
                    const f = document.getElementById('filter-user').value; 
                    if (f !== 'all') deals = deals.filter(d => d.owner === f); 
                } else { 
                    deals = deals.filter(d => d.owner === APP.user.name); 
                }
                
                cols.forEach(c => {
                    const items = deals.filter(d => d.stage === c.id);
                    const totalCol = items.reduce((acc, curr) => acc + curr.value, 0);
                    const div = document.createElement('div'); div.className = 'kanban-col';
                    div.ondragover = e => { e.preventDefault(); div.classList.add('drag-over'); };
                    div.ondragleave = e => div.classList.remove('drag-over');
                    div.ondrop = e => { e.preventDefault(); div.classList.remove('drag-over'); if(APP.dragId) APP.updateStage(APP.dragId, c.id); };
                    let html = `<div class="kanban-header" style="background:${c.c}"><div>${c.l} (${items.length})</div><div class="kanban-header-total">${totalCol.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div><div class="kanban-list">`;
                    items.forEach(d => {
                        let actionHtml = '';
                        if(d.stage === 'perdido' && d.next_desc && d.next_desc.includes('PERDA')) { actionHtml = `<div class="card-action" style="color:#991b1b; font-weight:800; background:#fee2e2;">${d.next_desc}</div>`; }
                        else if(d.next_date) {
                            const today = new Date().toISOString().split('T')[0];
                            const color = d.next_date < today ? '#ef4444' : '#2563eb';
                            const dateBr = d.next_date.split('-').reverse().join('/');
                            actionHtml = `<div class="card-action" style="color:${color}">üìÖ ${dateBr} - ${d.next_desc}</div>`;
                        }
                        
                        let deleteBtn = `<button class="btn-card-icon btn-card-delete" onclick="event.stopPropagation(); APP.deleteDeal('${d.id}')" title="Excluir">üóëÔ∏è</button>`;
                        if (isAssistente) deleteBtn = '';

                        html += `<div class="card" draggable="true" onclick="APP.editDeal('${d.id}')" ondragstart="APP.dragId='${d.id}'; this.classList.add('dragging')" ondragend="this.classList.remove('dragging')"><div class="card-tags"><span class="tag">üë§ ${d.owner}</span><div class="card-btn-group"><button class="btn-card-icon" onclick="event.stopPropagation(); APP.viewHistory('${d.id}', 'deal')" title="Hist√≥rico">üìú</button>${deleteBtn}</div></div><div style="font-weight:800; margin-bottom:5px;">${d.client}</div><div style="font-weight:700; color:#374151;">${d.value.toLocaleString('pt-BR', {minimumFractionDigits:2})}</div>${actionHtml}</div>`;
                    });
                    html += '</div>'; div.innerHTML = html; container.appendChild(div);
                });
            },

            renderAgenda: () => {
                if (!APP.user) return; // FIX: Previne erro ao iniciar sem utilizador

                const container = document.getElementById('agenda-content');
                if(!container) return;
                let deals = APP.data.deals.filter(d => d.stage !== 'ganho' && d.stage !== 'perdido' && d.next_date);
                
                const isGestor = APP.user.role === 'gestor';
                const isAssistente = APP.user.role === 'assistente';

                if (!isGestor && !isAssistente) { deals = deals.filter(d => d.owner === APP.user.name); }
                
                if(deals.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px; color:#9ca3af;">Nenhuma tarefa agendada.</div>'; return; }
                const today = new Date().toISOString().split('T')[0];
                const delayed = []; const todayList = []; const future = [];
                deals.sort((a,b) => a.next_date.localeCompare(b.next_date));
                deals.forEach(d => {
                    if (d.next_date < today) delayed.push(d); else if (d.next_date === today) todayList.push(d); else future.push(d);
                });
                const buildList = (title, list, className) => {
                    if(list.length === 0) return '';
                    let html = `<div class="agenda-group"><h4>${title} (${list.length})</h4>`;
                    list.forEach(d => {
                        const dateBr = d.next_date.split('-').reverse().join('/');
                        html += `<div class="agenda-item ${className}" onclick="APP.editDeal('${d.id}')" style="cursor:pointer"><div class="agenda-date">${dateBr}</div><div class="agenda-info"><div class="agenda-client">${d.client}</div><div class="agenda-desc">${d.next_desc || 'Sem descri√ß√£o'}</div></div><div style="font-size:10px; font-weight:700; background:#f3f4f6; padding:2px 5px; border-radius:3px; text-transform:uppercase;">${d.owner}</div></div>`;
                    });
                    html += '</div>'; return html;
                };
                container.innerHTML = buildList('‚ö† Atrasadas', delayed, 'delayed') + buildList('üìÖ Hoje', todayList, 'today') + buildList('üöÄ Pr√≥ximas', future, 'future');
            },

            renderKPIs: () => {
                if (!APP.user) return; // FIX: Previne erro ao iniciar sem utilizador

                const isGestor = APP.user.role === 'gestor';
                const isAssistente = APP.user.role === 'assistente';
                
                const scopeDeals = (isGestor || isAssistente) ? APP.data.deals : APP.data.deals.filter(d => d.owner === APP.user.name);
                
                // --- ALTERA√á√ÉO: FILTRO POR M√äS ATUAL ---
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                const wonDeals = scopeDeals.filter(d => {
                    if (d.stage !== 'ganho') return false;
                    if (!d.close_date) return false;
                    const dDate = new Date(d.close_date);
                    return dDate.getMonth() === currentMonth && dDate.getFullYear() === currentYear;
                });
                // ----------------------------------------

                const totalRevenue = wonDeals.reduce((a,b) => a+b.value, 0);
                document.getElementById('lbl-faturamento').innerText = (isGestor || isAssistente) ? "Faturamento (M√™s)" : "Meu Faturamento (M√™s)";
                document.getElementById('kpi-total').innerText = totalRevenue.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                
                let totalMargin = 0;
                wonDeals.forEach(d => {
                    let cost = 0;
                    if (d.original_cost !== undefined) { cost = d.original_cost; } else if (d.stock_id) {
                        const stockItem = APP.data.stock.find(s => s.id === d.stock_id);
                        if (stockItem) { cost = stockItem.cost; }
                    }
                    totalMargin += (d.value - cost);
                });
                let marginPct = 0; if (totalRevenue > 0) { marginPct = (totalMargin / totalRevenue) * 100; }
                const pctColor = marginPct >= 0 ? '#10b981' : '#ef4444';
                document.getElementById('kpi-margin').innerHTML = `${totalMargin.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})} <span style="font-size:14px; color:${pctColor}; margin-left:5px;">(${marginPct.toFixed(1)}%)</span>`;
                
                const openDealsList = scopeDeals.filter(d => d.stage !== 'ganho' && d.stage !== 'perdido');
                const pipelineValue = openDealsList.reduce((a,b) => a+b.value, 0);
                document.getElementById('kpi-pipeline').innerText = pipelineValue.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                
                const gridContainer = document.getElementById('dash-inventory-grid');
                
                if (!isGestor && !isAssistente) { gridContainer.innerHTML = ''; return; }
                
                const blockedStock = APP.data.stock.filter(s => s.status === 'Reservado');
                const blockedValue = blockedStock.reduce((a, b) => a + b.cost, 0);
                const availableStock = APP.data.stock.filter(s => s.status === 'Dispon√≠vel');
                const types = {}; let totalStockValue = 0; let criticalValue = 0;
                availableStock.forEach(s => {
                    if(!types[s.type]) types[s.type] = 0; types[s.type] += s.cost; totalStockValue += s.cost;
                    const entryDate = s.date_entry ? new Date(s.date_entry).getTime() : Date.now();
                    if(APP.daysDiff(entryDate) > 365) criticalValue += s.cost;
                });
                let gridHtml = `<div class="inv-card"><div class="inv-label">üí∞ Estoque Total</div><div class="inv-value">${totalStockValue.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div>`;
                for (const [type, val] of Object.entries(types)) {
                    gridHtml += `<div class="inv-card"><div class="inv-label">üöú ${type}</div><div class="inv-value" style="font-size:16px;">${val.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div>`;
                }
                gridHtml += `<div class="inv-card blocked"><div class="inv-label">üîí Reservado/Em Disputa</div><div class="inv-value">${blockedValue.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div>`;
                gridHtml += `<div class="inv-card critical"><div class="inv-label">üö® Capital Cr√≠tico (>365d)</div><div class="inv-value">${criticalValue.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</div></div>`;
                gridContainer.innerHTML = gridHtml;
            },

            renderReports: () => {
                if (!APP.user) return; // FIX: Previne erro ao iniciar sem utilizador

                const startStr = document.getElementById('rep-start').value;
                const endStr = document.getElementById('rep-end').value;
                const sourceFilter = document.getElementById('rep-source').value;
                const sellerFilter = document.getElementById('rep-seller').value;
                if(!startStr || !endStr) return;
                const startDate = new Date(startStr).getTime();
                const endDate = new Date(endStr).getTime() + 86400000;
                const tbody = document.querySelector('#table-reports tbody');
                let html = ''; let totalVal = 0; let count = 0;
                
                const isGestor = APP.user.role === 'gestor';
                const isAssistente = APP.user.role === 'assistente';

                APP.data.deals.forEach(d => {
                    const dealDateStr = d.close_date || (d.history && d.history[0] ? d.history[0].date : 0);
                    const dealDate = new Date(dealDateStr).getTime();
                    if (d.stage === 'ganho' && dealDate >= startDate && dealDate < endDate) {
                        if (sourceFilter !== 'all' && d.source !== sourceFilter) return;
                        
                        if (!isGestor && !isAssistente && d.owner !== APP.user.name) return;
                        if ((isGestor || isAssistente) && sellerFilter !== 'all' && d.owner !== sellerFilter) return;
                        
                        totalVal += d.value; count++;
                        let prodName = 'Cons√≥rcio/Servi√ßo'; let cost = 0;
                        if(d.stock_id) { const s = APP.data.stock.find(x => x.id === d.stock_id); if(s) prodName = s.model; }
                        if (d.original_cost !== undefined) { cost = d.original_cost; } else if (d.stock_id) { const stockItem = APP.data.stock.find(s => s.id === d.stock_id); if (stockItem) cost = stockItem.cost; }
                        const marginVal = d.value - cost; const marginPct = d.value > 0 ? ((marginVal / d.value) * 100).toFixed(1) + '%' : '0%'; const marginColor = marginVal >= 0 ? '#10b981' : '#ef4444';
                        const dateBr = new Date(dealDate).toLocaleDateString('pt-BR');
                        html += `<tr><td>${dateBr}</td><td><b>${d.client}</b></td><td>${d.source || '-'}</td><td>${d.owner}</td><td>${prodName}</td><td>${d.value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td><td style="color:${marginColor}; font-weight:bold;">${marginVal.toLocaleString('pt-BR', {minimumFractionDigits: 2})} <small>(${marginPct})</small></td></tr>`;
                    }
                });
                if(count === 0) html = '<tr><td colspan="7" style="text-align:center; padding:20px;">Nenhuma venda encontrada com estes filtros.</td></tr>';
                tbody.innerHTML = html;
                document.getElementById('rep-total-val').innerText = totalVal.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                document.getElementById('rep-total-count').innerText = count;
            },

            viewHistory: (id, type) => {
                let list = []; let title = '';
                if (type === 'stock') {
                    const item = APP.data.stock.find(s => s.id === id);
                    if(item) { list = item.history || []; title = `Hist√≥rico: ${item.model}`; }
                } else {
                    const deal = APP.data.deals.find(d => d.id === id);
                    if(deal) { list = deal.history || []; title = `Hist√≥rico: ${deal.client}`; }
                }
                document.getElementById('hist-title').innerText = title;
                const container = document.getElementById('history-content');
                if(!list || list.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#9ca3af; padding:20px;">Sem hist√≥rico registrado.</div>';
                } else {
                    container.innerHTML = list.sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime()).map(h => {
                        const dateObj = new Date(h.date);
                        const dateStr = dateObj.toLocaleDateString('pt-BR') + ' ' + dateObj.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                        return `<div class="timeline-item"><div class="timeline-date">${dateStr}</div><div class="timeline-action">${h.action}</div><div class="timeline-detail">${h.detail}</div><div class="timeline-user">Por: ${h.user || 'Sistema'}</div></div>`;
                    }).join('');
                }
                APP.modal('modal-history');
            },

            parseMoney: (v) => { if (typeof v === 'number') return v; if (!v) return 0; return parseFloat(v.toString().replace(/[R$‚Ç¨\s]/g, '').replace(/\./g, '').replace(',', '.').trim()) || 0; },
            parseDateBR: (dateStr) => { if (!dateStr) return Date.now(); const parts = dateStr.trim().split('/'); if (parts.length === 3) return new Date(parts[2], parts[1]-1, parts[0]).getTime(); return Date.now(); },
            daysDiff: (ts) => Math.floor((Date.now() - ts) / 86400000),
            maskMoney: (i) => { let v = i.value.replace(/\D/g, ''); v = (v/100).toFixed(2).replace(".", ",").replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1."); i.value = v; },
            inputPhone: (i) => { let v = i.value.replace(/\D/g,""); v = v.replace(/^(\d{2})(\d)/g,"($1) $2"); v = v.replace(/(\d)(\d{4})$/,"$1-$2"); i.value = v; },
            openWhatsapp: (phone) => { if(!phone) return alert('Sem telefone cadastrado'); const num = phone.replace(/\D/g, ''); window.open(`https://wa.me/55${num}`, '_blank'); },
            exportData: () => { 
                const wb = XLSX.utils.book_new(); 
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(APP.data.stock), "Estoque"); 
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(APP.data.deals), "Neg√≥cios"); 
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(APP.data.clients), "Clientes");
                XLSX.writeFile(wb, "YattaCRM_Backup.xlsx"); 
            },
            
            // ATUALIZA√á√ÉO: ADICIONADAS NOVAS FUN√á√ïES NO RENDERALL
            renderAll: () => { 
                APP.renderStock(); 
                APP.renderKanban(); 
                APP.renderUsers(); 
                APP.renderKPIs(); 
                APP.renderClients(); 
                APP.renderAgenda(); 
                APP.renderCatalog(); // NOVA TABELA DE CAT√ÅLOGO (SUBSTITUI SALES TABLE)
                APP.renderGoals(); // NOVO WIDGET DE METAS
            },
        };

        document.addEventListener('DOMContentLoaded', APP.init);
    </script>
</body>
</html>