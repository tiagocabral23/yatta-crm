<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agendamento P√≥s-Venda | Concession√°ria</title>
    
    <!-- Tailwind CSS (Estilo Visual) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- √çcones (Phosphor Icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Supabase SDK (Banco de Dados) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js para gr√°ficos perform√°ticos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ESTILOS (CSS) -->
    <style type="text/tailwindcss">
        body { font-family: 'Inter', sans-serif; }
        
        /* Barra de rolagem escura */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
        }

        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Cores de Status */
        .status-pendente { @apply bg-yellow-900/80 text-yellow-100 border-yellow-600; }
        .status-confirmado { @apply bg-blue-900/80 text-blue-100 border-blue-600; }
        .status-concluido { @apply bg-emerald-900/80 text-emerald-100 border-emerald-600; }
        .status-cancelado { @apply bg-red-900/80 text-red-100 border-red-600; }
        .status-espera { @apply bg-zinc-800 text-zinc-300 border-zinc-600 border-dashed; }
        /* Novo Status: Bloqueado */
        .status-bloqueado { 
            @apply bg-zinc-800 text-zinc-400 border-zinc-600;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, #3f3f46 10px, #3f3f46 20px);
        }

        .cursor-move { cursor: grab; }
        .cursor-move:active { cursor: grabbing; }
        
        .slot-hover-highlight:hover {
            background-color: #27272a; 
            border-color: #eab308;
        }

        .slot-height { height: 140px; }

        .blocked-slot {
            background-image: linear-gradient(45deg, #18181b 25%, #27272a 25%, #27272a 50%, #18181b 50%, #18181b 75%, #27272a 75%, #27272a 100%);
            background-size: 20px 20px;
            opacity: 0.5;
        }

        .nav-btn.active {
            @apply text-yellow-500 border-b-2 border-yellow-500 bg-yellow-500/10;
        }
        .nav-btn {
            @apply text-zinc-400 hover:text-white transition-all border-b-2 border-transparent pb-1 px-3 rounded-t-lg;
        }

        /* KPI Cards Espec√≠ficos */
        .kpi-card { @apply bg-zinc-900 border border-zinc-800 rounded-xl p-5 relative overflow-hidden transition-all hover:border-zinc-700; }
        .kpi-title { @apply text-zinc-400 text-xs font-bold uppercase tracking-wider mb-1; }
        .kpi-value { @apply text-3xl font-bold text-white; }
        .kpi-context { @apply text-xs mt-2 font-medium; }
    </style>
</head>
<body class="bg-zinc-950 h-screen flex flex-col overflow-hidden text-zinc-100">

    <!-- TELA DE LOGIN -->
    <div id="loginScreen" class="fixed inset-0 z-50 bg-zinc-950 flex items-center justify-center fade-in px-4">
        <div class="bg-zinc-900 p-8 rounded-2xl shadow-2xl border border-zinc-800 w-full max-w-md text-center">
            <div class="inline-flex items-center justify-center bg-yellow-500 p-4 rounded-full text-zinc-900 mb-6 shadow-lg shadow-yellow-500/20">
                <i class="ph-fill ph-tractor text-4xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">AgroTech P√≥s-Venda</h1>
            <p class="text-zinc-400 mb-8">Gest√£o Operacional de Oficina</p>
            
            <div class="space-y-4">
                <button onclick="login('gestor')" class="w-full bg-zinc-800 hover:bg-zinc-700 hover:border-yellow-500 border border-zinc-700 text-white font-semibold py-4 px-6 rounded-xl transition-all flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                        <i class="ph-fill ph-user-gear text-2xl text-zinc-500 group-hover:text-yellow-500 transition-colors"></i>
                        <div class="text-left">
                            <div class="text-sm text-zinc-400 group-hover:text-white">Acesso Administrativo</div>
                            <div class="text-lg">Gestor de P√≥s-Venda</div>
                        </div>
                    </div>
                    <i class="ph-bold ph-arrow-right text-zinc-600 group-hover:text-yellow-500"></i>
                </button>

                <button onclick="login('mecanico')" class="w-full bg-zinc-800 hover:bg-zinc-700 hover:border-blue-500 border border-zinc-700 text-white font-semibold py-4 px-6 rounded-xl transition-all flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                        <i class="ph-fill ph-wrench text-2xl text-zinc-500 group-hover:text-blue-500 transition-colors"></i>
                        <div class="text-left">
                            <div class="text-sm text-zinc-400 group-hover:text-white">Acesso Operacional</div>
                            <div class="text-lg">Mec√¢nico / T√©cnico</div>
                        </div>
                    </div>
                    <i class="ph-bold ph-arrow-right text-zinc-600 group-hover:text-blue-500"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Aviso de Configura√ß√£o -->
    <div id="configWarning" class="hidden bg-yellow-600 text-black font-bold text-xs py-1 px-4 text-center">
        ‚ö† MODO LOCAL: Dados salvos no navegador. Configure o Supabase para persist√™ncia em nuvem.
    </div>

    <!-- Cabe√ßalho -->
    <header class="bg-zinc-900 border-b border-zinc-800 px-4 md:px-6 py-3 flex flex-col md:flex-row md:items-center justify-between shrink-0 z-10 shadow-md gap-4">
        <div class="flex items-center justify-between w-full md:w-auto gap-6">
            <div class="flex items-center gap-3">
                <div class="bg-yellow-500 p-1.5 rounded-lg text-zinc-900 shrink-0">
                    <i class="ph-fill ph-tractor text-xl"></i>
                </div>
                <div>
                    <h1 class="text-base md:text-lg font-bold text-white leading-tight">Agendamento</h1>
                    <p class="text-[10px] text-zinc-500 font-bold tracking-widest uppercase" id="headerRole">PAINEL DE CONTROLE</p>
                </div>
            </div>

            <!-- Navega√ß√£o Central -->
            <nav class="flex items-center gap-2 md:gap-4 md:ml-8 text-sm font-semibold" id="mainNav">
                <button onclick="switchView('agenda')" id="navAgenda" class="nav-btn active flex items-center gap-2 py-2">
                    <i class="ph ph-calendar text-lg"></i> <span class="hidden md:inline">Agenda Operacional</span>
                </button>
                <button onclick="switchView('dashboard')" id="navDashboard" class="nav-btn flex items-center gap-2 py-2">
                    <i class="ph ph-chart-line-up text-lg"></i> <span class="hidden md:inline">Dashboard de Gest√£o</span>
                </button>
            </nav>
            
            <button onclick="logout()" class="md:hidden text-zinc-500 hover:text-red-400 text-xl">
                <i class="ph-bold ph-sign-out"></i>
            </button>
        </div>

        <div class="flex flex-wrap md:flex-nowrap items-center gap-4 w-full md:w-auto justify-between md:justify-end">
            <!-- Bot√£o Sair Desktop -->
            <button onclick="logout()" class="hidden md:flex text-zinc-500 hover:text-red-400 text-xs items-center gap-1 font-medium px-2 py-1 hover:bg-zinc-800 rounded transition">
                <i class="ph-bold ph-sign-out"></i> Sair
            </button>

            <!-- Controles Agenda -->
            <div id="agendaControls" class="flex flex-wrap md:flex-nowrap items-center gap-2 md:gap-4 w-full md:w-auto">
                <div class="flex flex-1 md:flex-none items-center justify-between bg-zinc-800 rounded-lg p-1 border border-zinc-700">
                    <button onclick="changeDate(-1)" class="p-1.5 hover:bg-zinc-700 rounded-md transition-all text-zinc-400 hover:text-white">
                        <i class="ph ph-caret-left"></i>
                    </button>
                    <div class="px-2 md:px-4 font-semibold text-zinc-200 text-sm min-w-[120px] text-center uppercase tracking-wide" id="currentDateDisplay"></div>
                    <button onclick="changeDate(1)" class="p-1.5 hover:bg-zinc-700 rounded-md transition-all text-zinc-400 hover:text-white">
                        <i class="ph ph-caret-right"></i>
                    </button>
                </div>

                <div id="managerActions" class="flex items-center gap-2 ml-auto">
                    <button onclick="openTechnicianModal()" class="flex items-center justify-center gap-2 px-3 py-2 text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-lg transition-colors border border-transparent hover:border-zinc-700" title="T√©cnicos">
                        <i class="ph ph-users text-lg"></i>
                    </button>
                    
                    <button onclick="openAppointmentModal()" class="flex items-center gap-2 bg-yellow-500 hover:bg-yellow-400 text-zinc-900 px-4 py-2 rounded-lg font-bold transition-colors shadow-lg shadow-yellow-500/10 text-sm">
                        <i class="ph-bold ph-plus"></i>
                        <span class="hidden md:inline">Novo Servi√ßo</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- VIEW: AGENDA (Grid) -->
    <div id="viewAgenda" class="flex-1 flex flex-col md:flex-row overflow-hidden">
        <main class="flex-1 flex flex-col overflow-hidden relative bg-zinc-950 order-1 md:order-1" id="mainGridArea">
            <div class="flex-1 overflow-x-auto overflow-y-hidden flex relative" id="scheduleContainer">
                <div class="w-16 md:w-20 shrink-0 bg-zinc-900 border-r border-zinc-800 flex flex-col z-10 sticky left-0 shadow-lg">
                    <div class="h-12 border-b border-zinc-800 bg-zinc-900 flex items-center justify-center font-bold text-[10px] text-zinc-500 uppercase tracking-wider">
                        Hora
                    </div>
                    <div id="timeSlotsColumn" class="flex-1 overflow-hidden pb-20 bg-zinc-900"></div>
                </div>

                <div class="flex-1 overflow-y-auto relative" id="mainScrollArea">
                    <div id="techniciansHeader" class="flex sticky top-0 z-10 bg-zinc-900 border-b border-zinc-800 h-12 shadow-sm"></div>
                    <div id="scheduleGrid" class="flex relative pb-20"></div>
                </div>
            </div>
        </main>

        <!-- Barra Lateral de Espera (Backlog) -->
        <aside id="waitingListSidebar" class="w-full h-48 md:h-auto md:w-80 bg-zinc-900 border-t md:border-t-0 md:border-l border-zinc-800 flex flex-col z-20 shadow-xl shrink-0 order-2 md:order-2">
            <div class="h-10 md:h-14 border-b border-zinc-800 flex items-center justify-between px-4 bg-zinc-900 shrink-0">
                <h3 class="font-bold text-zinc-100 flex items-center gap-2 text-sm uppercase tracking-wide">
                    <i class="ph-fill ph-tray text-yellow-500"></i>
                    Fila de Espera
                </h3>
                <span id="waitingCount" class="bg-zinc-800 text-zinc-400 text-xs px-2 py-0.5 rounded border border-zinc-700 font-mono">0</span>
            </div>
            <div id="waitingListContainer" class="flex-1 overflow-y-auto p-3 space-y-2 bg-zinc-950/30"></div>
        </aside>
    </div>

    <!-- VIEW: DASHBOARD -->
    <div id="viewDashboard" class="flex-1 hidden bg-zinc-950 p-4 md:p-8 overflow-y-auto">
        <div class="max-w-7xl mx-auto space-y-6">
            
            <!-- T√≠tulo da Se√ß√£o -->
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-white">Vis√£o Executiva</h2>
                    <p class="text-zinc-500 text-sm">Monitoramento de efici√™ncia e riscos operacionais</p>
                </div>
                <div class="flex gap-2 text-xs font-medium bg-zinc-900 p-1 rounded-lg border border-zinc-800">
                    <span class="px-3 py-1 bg-zinc-800 rounded text-zinc-300">Hoje</span>
                    <span class="px-3 py-1 text-zinc-500 hover:text-zinc-300 cursor-pointer">Semana</span>
                    <span class="px-3 py-1 text-zinc-500 hover:text-zinc-300 cursor-pointer">M√™s</span>
                </div>
            </div>

            <!-- LINHA 1: Indicadores Cr√≠ticos (Health Check) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                
                <!-- KPI 1: Qualidade (Taxa de Retorno) - O mais cr√≠tico -->
                <div class="kpi-card group border-l-4 border-l-transparent" id="cardQuality">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="kpi-title">Qualidade / Retorno</p>
                            <h3 class="kpi-value" id="kpiReturnRate">0%</h3>
                        </div>
                        <div class="p-2 bg-zinc-800 rounded-lg text-zinc-500 group-hover:text-white transition-colors">
                            <i class="ph-fill ph-arrow-u-down-left text-xl"></i>
                        </div>
                    </div>
                    <p class="kpi-context" id="kpiReturnContext">-- servi√ßos refeitas</p>
                </div>

                <!-- KPI 2: Capacidade (Ocupa√ß√£o Hoje) -->
                <div class="kpi-card group">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="kpi-title">Ocupa√ß√£o Hoje</p>
                            <h3 class="kpi-value text-yellow-500" id="kpiOccupancy">0%</h3>
                        </div>
                        <div class="p-2 bg-zinc-800 rounded-lg text-zinc-500 group-hover:text-yellow-500 transition-colors">
                            <i class="ph-fill ph-users-three text-xl"></i>
                        </div>
                    </div>
                    <div class="w-full bg-zinc-800 h-1 mt-3 rounded-full overflow-hidden">
                        <div id="barOccupancy" class="bg-yellow-500 h-full" style="width: 0%"></div>
                    </div>
                    <p class="text-[10px] text-zinc-500 mt-1" id="kpiOccupancyText">--/-- slots preenchidos</p>
                </div>

                <!-- KPI 3: Risco de Fila (SLA Estourado) -->
                <div class="kpi-card group border-l-4 border-l-transparent" id="cardBacklogRisk">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="kpi-title">Fila de Espera Cr√≠tica (>7d)</p>
                            <h3 class="kpi-value" id="kpiCriticalBacklog">0</h3>
                        </div>
                        <div class="p-2 bg-zinc-800 rounded-lg text-zinc-500 group-hover:text-red-500 transition-colors">
                            <i class="ph-fill ph-warning text-xl"></i>
                        </div>
                    </div>
                    <p class="kpi-context text-zinc-500">Clientes em risco de churn</p>
                </div>

                 <!-- KPI 4: Mix Financeiro (Garantia vs Pagante) -->
                 <div class="kpi-card group">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="kpi-title">√çndice de Garantia</p>
                            <h3 class="kpi-value text-blue-400" id="kpiWarrantyRate">0%</h3>
                        </div>
                        <div class="p-2 bg-zinc-800 rounded-lg text-zinc-500 group-hover:text-blue-400 transition-colors">
                            <i class="ph-fill ph-seal-check text-xl"></i>
                        </div>
                    </div>
                    <p class="kpi-context text-zinc-500">Volume de servi√ßos de f√°brica</p>
                </div>
            </div>

            <!-- LINHA 2: Gest√£o Operacional e Aten√ß√£o -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Tabela de Performance T√©cnica -->
                <div class="lg:col-span-2 bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden flex flex-col">
                    <div class="px-6 py-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-900/50">
                        <h3 class="font-bold text-white text-sm uppercase tracking-wide flex items-center gap-2">
                            <i class="ph-fill ph-wrench text-zinc-500"></i> Efici√™ncia T√©cnica
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-zinc-400">
                            <thead class="bg-zinc-950 text-xs uppercase font-bold text-zinc-500">
                                <tr>
                                    <th class="px-6 py-3">T√©cnico</th>
                                    <th class="px-6 py-3 text-center">Volume</th>
                                    <th class="px-6 py-3 text-center">Retornos</th>
                                    <th class="px-6 py-3 text-center">Status Hoje</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-zinc-800" id="techPerformanceTable">
                                <!-- Preenchido via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Lista de Aten√ß√£o Imediata (Action items) -->
                <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-5 flex flex-col h-full">
                    <h3 class="font-bold text-red-400 text-sm uppercase tracking-wide mb-4 flex items-center gap-2">
                        <i class="ph-fill ph-siren"></i> Aten√ß√£o Imediata
                    </h3>
                    <div class="flex-1 overflow-y-auto space-y-3" id="actionItemsList">
                        <!-- Itens cr√≠ticos inseridos aqui -->
                        <div class="text-center text-zinc-600 text-xs italic mt-10">Tudo sob controle.</div>
                    </div>
                </div>

            </div>

            <!-- LINHA 3: Contexto Log√≠stico -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Localiza√ß√£o do Servi√ßo (Custo Log√≠stico) -->
                <div class="bg-zinc-900 p-5 rounded-xl border border-zinc-800">
                    <h4 class="text-xs font-bold text-zinc-500 uppercase tracking-wide mb-4">Custo Log√≠stico (Local)</h4>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-zinc-300">Campo (Alto Custo)</span>
                                <span class="text-white font-bold" id="statFieldPct">0%</span>
                            </div>
                            <div class="w-full bg-zinc-800 rounded-full h-2">
                                <div id="barField" class="bg-yellow-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-zinc-300">Oficina (Interno)</span>
                                <span class="text-white font-bold" id="statWorkshopPct">0%</span>
                            </div>
                            <div class="w-full bg-zinc-800 rounded-full h-2">
                                <div id="barWorkshop" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resumo Garantia -->
                <div class="bg-zinc-900 p-5 rounded-xl border border-zinc-800 flex items-center justify-between">
                    <div>
                         <h4 class="text-xs font-bold text-zinc-500 uppercase tracking-wide mb-1">Total em Garantia</h4>
                         <div class="text-3xl font-bold text-white" id="statWarrantyTotal">0</div>
                         <p class="text-xs text-zinc-500 mt-1">Servi√ßos faturados para f√°brica</p>
                    </div>
                    <div class="h-16 w-16 rounded-full border-4 border-zinc-800 border-t-blue-500 flex items-center justify-center">
                        <i class="ph-fill ph-medal text-2xl text-blue-500"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Novo/Editar Agendamento -->
    <div id="appointmentModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center fade-in text-zinc-800 p-2 md:p-0">
        <div class="bg-zinc-900 w-full max-w-2xl rounded-xl shadow-2xl border border-zinc-700 flex flex-col max-h-[95vh] md:max-h-[90vh]">
            <div class="px-4 md:px-6 py-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-900 rounded-t-xl shrink-0">
                <h3 class="text-base md:text-lg font-bold text-white flex items-center gap-2">
                    <i class="ph ph-calendar-plus text-yellow-500"></i>
                    <span id="modalTitle">Novo Agendamento</span>
                </h3>
                <button onclick="closeModal('appointmentModal')" class="text-zinc-500 hover:text-white p-1 rounded-full hover:bg-zinc-800 transition">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            
            <div class="p-4 md:p-6 overflow-y-auto text-zinc-300">
                <form id="appointmentForm" class="space-y-4 md:space-y-5">
                    <input type="hidden" id="appointmentId">
                    
                    <!-- Switch Tipo de Evento -->
                    <div class="bg-zinc-800 p-1 rounded-lg flex text-xs font-bold mb-4">
                        <button type="button" onclick="setEventType('service')" id="typeServiceBtn" class="flex-1 py-2 rounded text-center transition-colors bg-zinc-600 text-white">Servi√ßo / Cliente</button>
                        <button type="button" onclick="setEventType('blocked')" id="typeBlockedBtn" class="flex-1 py-2 rounded text-center transition-colors text-zinc-400 hover:text-white">Bloqueio / Indispon√≠vel</button>
                    </div>

                    <!-- Campos de Cliente (Vis√≠vel apenas se Tipo = Servi√ßo) -->
                    <div id="clientFieldsContainer">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">Cliente / Fazenda</label>
                                <input type="text" id="clientName" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none transition text-white placeholder-zinc-600" placeholder="Ex: Fazenda Santa Luzia">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">Contato</label>
                                <input type="text" id="clientPhone" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none text-white placeholder-zinc-600" placeholder="(00) 00000-0000">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-zinc-800/50 p-4 rounded-lg border border-zinc-700 mb-4">
                            <div class="col-span-1">
                                <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">Modelo Trator</label>
                                <input type="text" id="tractorModel" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none text-white placeholder-zinc-600" placeholder="Ex: 7210J">
                            </div>
                            <div class="col-span-1">
                                <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">S√©rie / ID</label>
                                <input type="text" id="monoblock" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none text-white placeholder-zinc-600" placeholder="Ex: ...X1234">
                            </div>
                            <div class="col-span-1 flex items-end">
                                <label class="flex items-center gap-3 cursor-pointer w-full px-3 py-2 border border-zinc-600 rounded-lg bg-zinc-800 hover:bg-zinc-700 transition select-none group">
                                    <input type="checkbox" id="isWarranty" class="w-4 h-4 text-blue-500 rounded focus:ring-blue-500 bg-zinc-900 border-zinc-600">
                                    <span class="text-sm font-medium text-zinc-300 group-hover:text-white">√â Garantia?</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Campo de Motivo de Bloqueio (Vis√≠vel apenas se Tipo = Bloqueio) -->
                    <div id="blockReasonContainer" class="hidden mb-4">
                        <label class="block text-xs font-bold text-red-500 uppercase mb-1">Motivo da Indisponibilidade</label>
                        <select id="blockReason" class="w-full px-3 py-2 bg-zinc-800 border border-red-500/50 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-white">
                            <option value="F√âRIAS">üèñÔ∏è F√©rias</option>
                            <option value="ATESTADO">üè• Atestado M√©dico</option>
                            <option value="TREINAMENTO">üìö Treinamento</option>
                            <option value="FOLGA">üè† Folga / Compensa√ß√£o</option>
                            <option value="MANUTEN√á√ÉO">üîß Manuten√ß√£o Ve√≠culo/Equip.</option>
                            <option value="OUTROS">üîí Outros</option>
                        </select>
                    </div>

                    <div id="commonFields">
                        <div>
                            <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">Tipo de Atendimento / Local</label>
                            <select id="serviceLocation" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none text-white">
                                <option value="Campo">Campo (Visita T√©cnica)</option>
                                <option value="Campo (Retorno)">üî¥ Campo (RETORNO)</option>
                                <option value="Oficina">Oficina (Interno)</option>
                                <option value="Oficina (Retorno)">üî¥ Oficina (RETORNO)</option>
                                <option value="Remoto">Atendimento Remoto</option>
                            </select>
                        </div>

                        <div class="mt-4">
                            <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">Relato / Observa√ß√µes</label>
                            <textarea id="description" rows="2" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none text-white placeholder-zinc-600" placeholder="Detalhes..."></textarea>
                        </div>
                    </div>

                    <!-- Campos de Agendamento -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 p-4 bg-zinc-800/30 rounded-lg border border-zinc-800" id="schedulingFields">
                        <div>
                            <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">T√©cnico Principal</label>
                            <select id="technicianSelect" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none text-white"></select>
                        </div>
                        <div id="tech2Container">
                            <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">T√©cnico Auxiliar</label>
                            <select id="technicianSelect2" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none text-white"></select>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-yellow-500 uppercase mb-1">Per√≠odo de In√≠cio</label>
                            <select id="periodSelect" class="w-full px-3 py-2 bg-zinc-800 border border-yellow-500/50 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none text-white">
                                <option value="morning">Manh√£ (08:00)</option>
                                <option value="afternoon">Tarde (13:30)</option>
                                <option value="full_day">Di√°ria Completa</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">Dura√ß√£o Estimada</label>
                            <select id="durationSlots" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none text-white">
                                <option value="1">1 Slot (~1h30)</option>
                                <option value="2">2 Slots (~3h)</option>
                                <option value="3">3 Slots (Turno)</option>
                            </select>
                        </div>

                        <div id="repeatContainer">
                            <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">Dura√ß√£o (Dias)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="repeatDays" min="1" max="30" value="1" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none text-white">
                                <span class="text-xs text-zinc-500 whitespace-nowrap">Consecutivos</span>
                            </div>
                        </div>
                    </div>

                    <!-- Anexos -->
                    <div id="attachmentsSection" class="mt-4 pt-4 border-t border-zinc-800">
                        <label class="block text-xs font-bold text-zinc-500 uppercase mb-2">Anexos / Fotos</label>
                        <div id="attachmentsList" class="grid grid-cols-2 gap-2 mb-3"></div>
                        <div class="flex flex-col md:flex-row gap-2">
                            <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect()">
                            <label for="fileInput" class="cursor-pointer flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 py-2 px-3 rounded text-sm border border-zinc-700 border-dashed text-center transition flex items-center justify-center gap-2">
                                <i class="ph ph-camera"></i> Selecionar Arquivo
                            </label>
                            <button type="button" onclick="uploadAttachment()" id="btnUpload" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Enviar
                            </button>
                        </div>
                        <p id="uploadStatus" class="text-xs text-zinc-500 mt-1"></p>
                    </div>

                    <div id="statusContainer" class="hidden mt-4 pt-4 border-t border-zinc-800">
                        <label class="block text-xs font-bold text-zinc-500 uppercase mb-2">Status do Servi√ßo</label>
                        <div class="flex gap-2 flex-wrap">
                            <button type="button" onclick="setStatus('pendente')" class="status-btn px-3 py-1 rounded-full text-xs font-bold border opacity-50 hover:opacity-100 status-pendente" data-status="pendente">Pendente</button>
                            <button type="button" onclick="setStatus('confirmado')" class="status-btn px-3 py-1 rounded-full text-xs font-bold border opacity-50 hover:opacity-100 status-confirmado" data-status="confirmado">Confirmado</button>
                            <button type="button" onclick="setStatus('concluido')" class="status-btn px-3 py-1 rounded-full text-xs font-bold border opacity-50 hover:opacity-100 status-concluido" data-status="concluido">Conclu√≠do</button>
                            <button type="button" onclick="setStatus('bloqueado')" class="status-btn px-3 py-1 rounded-full text-xs font-bold border opacity-50 hover:opacity-100 status-bloqueado" data-status="bloqueado">Bloqueado</button>
                            <button type="button" onclick="setStatus('cancelado')" class="status-btn px-3 py-1 rounded-full text-xs font-bold border opacity-50 hover:opacity-100 status-cancelado" data-status="cancelado">Cancelado</button>
                            <button type="button" onclick="setStatus('espera')" class="status-btn px-3 py-1 rounded-full text-xs font-bold border opacity-50 hover:opacity-100 status-espera" data-status="espera">Em Espera</button>
                        </div>
                        <input type="hidden" id="currentStatus" value="pendente">
                        <input type="hidden" id="currentEventType" value="service">
                    </div>

                </form>
            </div>

            <div class="px-4 md:px-6 py-4 border-t border-zinc-800 bg-zinc-900 rounded-b-xl flex flex-col-reverse md:flex-row justify-between gap-3 shrink-0" id="modalFooter">
                <button type="button" onclick="deleteAppointment()" id="btnDelete" class="hidden text-red-500 hover:text-red-400 text-sm font-medium px-4 py-2 hover:bg-red-900/20 rounded-lg transition w-full md:w-auto">Excluir</button>
                <div class="flex flex-col md:flex-row gap-3 ml-auto w-full md:w-auto">
                    <button onclick="closeModal('appointmentModal')" class="px-4 py-2 text-zinc-400 font-medium hover:bg-zinc-800 hover:text-white rounded-lg transition order-2 md:order-1">Cancelar</button>
                    <button id="btnSaveWait" onclick="saveAppointment('espera')" class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 font-medium rounded-lg transition border border-zinc-600 order-3 md:order-2">Mover para Fila de Espera</button>
                    <button id="btnSave" onclick="saveAppointment()" class="px-6 py-2 bg-yellow-500 hover:bg-yellow-400 text-black font-bold rounded-lg shadow-lg shadow-yellow-500/20 transition transform active:scale-95 order-1 md:order-3">Salvar Agenda</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Gerenciar T√©cnicos -->
    <div id="technicianModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center fade-in text-zinc-800 px-4">
        <div class="bg-zinc-900 w-full max-w-md rounded-xl shadow-2xl border border-zinc-700 overflow-hidden">
            <div class="px-6 py-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-900">
                <h3 class="text-lg font-bold text-white">Equipe T√©cnica</h3>
                <button onclick="closeModal('technicianModal')" class="text-zinc-500 hover:text-white"><i class="ph ph-x text-lg"></i></button>
            </div>
            <div class="p-6 text-zinc-300">
                <div class="flex gap-2 mb-6">
                    <input type="text" id="newTechName" placeholder="Nome do novo t√©cnico" class="flex-1 px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none text-white">
                    <button onclick="addTechnician()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg font-medium shadow-sm transition"><i class="ph ph-plus"></i></button>
                </div>
                <div class="space-y-2 max-h-64 overflow-y-auto" id="techList"></div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO SUPABASE
        const SUPABASE_URL = 'https://lgestnkullzjhlamqozh.supabase.co'; 
        const SUPABASE_ANON_KEY = 'sb_publishable_CEnVyqGq8ZjHgnWfPIcyYA_eNbowX5z';
        
        let supabaseClient = null; 
        let isDemoMode = false;
        let currentUserRole = 'gestor';

        let currentDate = new Date();
        let technicians = [];
        let appointments = [];
        let currentEditingId = null;
        let draggedAppointmentId = null;
        let selectedFile = null;

        const WORK_SLOTS = [
            { id: 0, label: 'Manh√£ - Vaga 1', time: '08:00', type: 'morning' },
            { id: 1, label: 'Manh√£ - Vaga 2', time: '10:00', type: 'morning' },
            { id: 2, label: 'Manh√£ - Vaga 3', time: '11:30', type: 'morning' },
            { id: 3, label: 'Tarde - Vaga 1', time: '13:30', type: 'afternoon' },
            { id: 4, label: 'Tarde - Vaga 2', time: '15:00', type: 'afternoon' },
            { id: 5, label: 'Tarde - Vaga 3', time: '16:30', type: 'afternoon' }
        ];

        // Dados de Demonstra√ß√£o aprimorados para simular cen√°rios reais
        const demoTechnicians = [
            { id: 1, name: 'Jo√£o Silva', color: 'bg-zinc-800 border-zinc-700 text-zinc-300' },
            { id: 2, name: 'Carlos Souza', color: 'bg-zinc-800 border-zinc-700 text-zinc-300' },
            { id: 3, name: 'Marcos Oliveira', color: 'bg-zinc-800 border-zinc-700 text-zinc-300' },
            { id: 4, name: 'Pedro Santos', color: 'bg-zinc-800 border-zinc-700 text-zinc-300' }
        ];

        function saveLocalData() {
            if (!isDemoMode) return;
            localStorage.setItem('posvenda_technicians', JSON.stringify(technicians));
            localStorage.setItem('posvenda_appointments', JSON.stringify(appointments));
        }

        function loadLocalData() {
            const storedTechs = localStorage.getItem('posvenda_technicians');
            const storedApps = localStorage.getItem('posvenda_appointments');
            
            if (storedTechs) technicians = JSON.parse(storedTechs);
            else technicians = [...demoTechnicians];

            if (storedApps) {
                appointments = JSON.parse(storedApps).map(a => ({
                    ...a,
                    start_time: new Date(a.start_time),
                    end_time: new Date(a.end_time),
                    attachments: a.attachments || []
                }));
            } else {
                appointments = [];
            }
        }

        function login(role) {
            if (role === 'gestor') {
                const password = prompt("Digite a senha de acesso:");
                if (password !== 'pvyatta2026*') {
                    alert("Senha incorreta!");
                    return;
                }
            }

            currentUserRole = role;
            document.getElementById('loginScreen').classList.add('hidden');
            updateInterfaceForRole();
            initApp();
        }

        function logout() {
            location.reload(); 
        }

        function updateInterfaceForRole() {
            const isMecanico = currentUserRole === 'mecanico';
            document.getElementById('headerRole').textContent = isMecanico ? 'PAINEL DO MEC√ÇNICO' : 'PAINEL DE CONTROLE';

            if (isMecanico) {
                document.getElementById('navDashboard').classList.add('hidden');
                document.getElementById('managerActions').classList.add('hidden');
                document.getElementById('waitingListSidebar').classList.add('hidden');
                switchView('agenda');
            } else {
                document.getElementById('navDashboard').classList.remove('hidden');
                document.getElementById('managerActions').classList.remove('hidden');
                document.getElementById('waitingListSidebar').classList.remove('hidden');
            }
        }

        function initApp() {
            renderTimeSlots();
            
            if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                try {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    loadDataSupabase();
                } catch(e) {
                    console.error("Erro Supabase init:", e);
                    enableDemoMode();
                }
            } else {
                enableDemoMode();
            }
            updateDateDisplay();

            const mainScroll = document.getElementById('mainScrollArea');
            const timeCol = document.getElementById('timeSlotsColumn');
            mainScroll.addEventListener('scroll', () => {
                timeCol.scrollTop = mainScroll.scrollTop;
            });
        }

        function enableDemoMode() {
            isDemoMode = true;
            document.getElementById('configWarning').classList.remove('hidden');
            loadLocalData();
            updateAllViews();
            console.warn("Rodando em modo DEMO com LocalStorage.");
        }

        function handleFileSelect() {
            const fileInput = document.getElementById('fileInput');
            selectedFile = fileInput.files[0];
            const btnUpload = document.getElementById('btnUpload');
            const status = document.getElementById('uploadStatus');
            
            if (selectedFile) {
                status.textContent = `Selecionado: ${selectedFile.name}`;
                btnUpload.disabled = false;
            } else {
                status.textContent = '';
                btnUpload.disabled = true;
            }
        }

        async function uploadAttachment() {
            if (!selectedFile) return;
            if (!currentEditingId) return alert("Salve o agendamento antes de anexar arquivos.");

            const btnUpload = document.getElementById('btnUpload');
            btnUpload.disabled = true;
            btnUpload.textContent = "Enviando...";

            let publicUrl = "";

            if (isDemoMode) {
                await new Promise(r => setTimeout(r, 1000));
                publicUrl = "#"; 
                const app = appointments.find(a => a.id === currentEditingId);
                if (app) {
                    if (!app.attachments) app.attachments = [];
                    app.attachments.push({ name: selectedFile.name, url: publicUrl });
                    saveLocalData();
                }
            } else {
                const fileName = `${Date.now()}_${selectedFile.name}`;
                const { data, error } = await supabaseClient.storage
                    .from('service-attachments')
                    .upload(`public/${currentEditingId}/${fileName}`, selectedFile);

                if (error) {
                    alert("Erro no upload: " + error.message);
                    btnUpload.textContent = "Enviar";
                    btnUpload.disabled = false;
                    return;
                }

                const { data: urlData } = supabaseClient.storage
                    .from('service-attachments')
                    .getPublicUrl(`public/${currentEditingId}/${fileName}`);
                
                publicUrl = urlData.publicUrl;

                const { data: currentApp } = await supabaseClient.from('appointments').select('attachments').eq('id', currentEditingId).single();
                const currentAttachments = currentApp?.attachments || [];
                const newAttachments = [...currentAttachments, { name: selectedFile.name, url: publicUrl }];

                await supabaseClient.from('appointments').update({ attachments: newAttachments }).eq('id', currentEditingId);
                loadDataSupabase();
            }

            document.getElementById('fileInput').value = "";
            selectedFile = null;
            btnUpload.textContent = "Enviar";
            btnUpload.disabled = true;
            document.getElementById('uploadStatus').textContent = "Upload conclu√≠do!";
            
            const app = appointments.find(a => a.id === currentEditingId); 
            renderAttachmentsList(app ? app.attachments : []);
        }

        function renderAttachmentsList(attachments) {
            const container = document.getElementById('attachmentsList');
            container.innerHTML = '';
            
            if (!attachments || attachments.length === 0) {
                container.innerHTML = '<span class="text-xs text-zinc-600 col-span-2 italic">Nenhum anexo.</span>';
                return;
            }

            attachments.forEach(att => {
                const div = document.createElement('div');
                div.className = 'bg-zinc-800 p-2 rounded border border-zinc-700 flex items-center justify-between';
                div.innerHTML = `<div class="flex items-center gap-2 overflow-hidden"><i class="ph ph-file text-zinc-400"></i><span class="text-xs text-zinc-300 truncate">${att.name}</span></div><a href="${att.url}" target="_blank" class="text-blue-500 hover:text-blue-400 text-xs font-bold">Ver</a>`;
                container.appendChild(div);
            });
        }

        function switchView(viewName) {
            if (currentUserRole === 'mecanico' && viewName === 'dashboard') return;

            const btnAgenda = document.getElementById('navAgenda');
            const btnDashboard = document.getElementById('navDashboard');
            const viewAgenda = document.getElementById('viewAgenda');
            const viewDashboard = document.getElementById('viewDashboard');
            const agendaControls = document.getElementById('agendaControls');

            if (viewName === 'agenda') {
                viewAgenda.classList.remove('hidden');
                viewDashboard.classList.add('hidden');
                btnAgenda.classList.add('active');
                btnDashboard.classList.remove('active');
                agendaControls.classList.remove('hidden');
            } else {
                viewAgenda.classList.add('hidden');
                viewDashboard.classList.remove('hidden');
                btnAgenda.classList.remove('active');
                btnDashboard.classList.add('active');
                agendaControls.classList.add('hidden');
                renderAdvancedDashboard(); // Renderiza o novo dashboard
            }
        }

        function renderWaitingList() {
            if (currentUserRole === 'mecanico') return;

            const container = document.getElementById('waitingListContainer');
            container.innerHTML = '';
            
            const waitingApps = appointments.filter(app => app.status === 'espera');
            document.getElementById('waitingCount').textContent = waitingApps.length;

            if (waitingApps.length === 0) {
                container.innerHTML = '<div class="text-center text-zinc-600 text-sm mt-10 italic">Fila limpa. √ìtimo trabalho!</div>';
                return;
            }

            const now = new Date();

            waitingApps.forEach(app => {
                const diffTime = Math.abs(now - new Date(app.start_time));
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 

                let borderClass = 'border-l-green-500';
                let timeClass = 'text-green-500';

                // Regras de Alerta de Backlog
                if (diffDays > 3 && diffDays <= 7) {
                    borderClass = 'border-l-yellow-500';
                    timeClass = 'text-yellow-500';
                } else if (diffDays > 7) {
                    borderClass = 'border-l-red-500';
                    timeClass = 'text-red-500';
                }

                const card = document.createElement('div');
                card.className = `bg-zinc-900 border border-zinc-700 border-l-4 ${borderClass} p-3 rounded shadow-sm cursor-move hover:bg-zinc-800 transition relative group`;
                card.draggable = true;
                card.ondragstart = (e) => handleDragStart(e, app.id);
                card.ondragend = handleDragEnd;

                const warrantyIcon = app.is_warranty ? '<i class="ph-fill ph-seal-check text-blue-400 ml-1" title="Garantia"></i>' : '';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-sm text-zinc-200 truncate pr-2">${app.client_name}</span>
                        <div class="flex items-center gap-1 shrink-0">
                             <span class="text-[10px] font-bold ${timeClass} border border-zinc-700 px-1 rounded bg-zinc-950">${diffDays}d</span>
                             ${warrantyIcon}
                        </div>
                    </div>
                    <div class="text-xs text-zinc-400 font-medium mb-2">${app.tractor_model}</div>
                    <div class="flex items-center gap-2 text-[10px] text-zinc-500">
                        <span class="bg-zinc-950 px-2 py-0.5 rounded border border-zinc-800 truncate max-w-[80px]">${app.location}</span>
                        ${app.description ? '<span class="truncate flex-1">'+app.description+'</span>' : ''}
                    </div>
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="text-zinc-400 hover:text-white"><i class="ph ph-pencil-simple"></i></button>
                    </div>
                `;
                
                card.querySelector('button').onclick = (e) => {
                    e.stopPropagation();
                    openAppointmentModal(null, app);
                };

                container.appendChild(card);
            });
        }

        // ==========================================
        // L√ìGICA DO NOVO DASHBOARD
        // ==========================================
        function renderAdvancedDashboard() {
            if (currentUserRole === 'mecanico') return;

            const now = new Date();
            const total = appointments.length;

            // --- 1. C√ÅLCULO DE KPIS CR√çTICOS (Ignorando Status Bloqueado) ---
            
            // Filtro Base: N√£o √© Espera nem Bloqueado
            const validAppointments = appointments.filter(a => a.status !== 'espera' && a.status !== 'bloqueado');
            
            // Taxa de Retorno (Qualidade)
            const returnServices = validAppointments.filter(a => 
                (a.location && a.location.toLowerCase().includes('retorno')) || 
                (a.description && a.description.toLowerCase().includes('retorno'))
            );
            const completedOrScheduled = validAppointments.length || 1;
            const returnRate = Math.round((returnServices.length / completedOrScheduled) * 100);

            const elReturnRate = document.getElementById('kpiReturnRate');
            const elReturnCard = document.getElementById('cardQuality');
            const elReturnContext = document.getElementById('kpiReturnContext');
            
            elReturnRate.textContent = `${returnRate}%`;
            elReturnContext.textContent = `${returnServices.length} servi√ßos refeitos`;
            
            elReturnCard.classList.remove('border-l-red-500', 'border-l-yellow-500', 'border-l-green-500');
            if(returnRate > 10) {
                elReturnCard.classList.add('border-l-red-500'); 
                elReturnRate.classList.add('text-red-500');
            } else if(returnRate > 5) {
                elReturnCard.classList.add('border-l-yellow-500'); 
                elReturnRate.classList.add('text-yellow-500');
            } else {
                elReturnCard.classList.add('border-l-green-500'); 
                elReturnRate.classList.add('text-green-500');
            }

            // Ocupa√ß√£o Hoje (Considera Bloqueios como Ocupado)
            const todayStr = now.toDateString();
            const todayApps = appointments.filter(a => a.status !== 'espera' && new Date(a.start_time).toDateString() === todayStr);
            
            let slotsUsed = 0;
            todayApps.forEach(a => {
                const duration = (new Date(a.end_time) - new Date(a.start_time)) / 60000;
                let s = Math.ceil(duration / 90); 
                if(s > 3) s = 3;
                slotsUsed += s;
            });
            
            const totalCapacity = technicians.length * 3; 
            const occupancyRate = totalCapacity > 0 ? Math.round((slotsUsed / totalCapacity) * 100) : 0;
            
            document.getElementById('kpiOccupancy').textContent = `${occupancyRate}%`;
            document.getElementById('barOccupancy').style.width = `${Math.min(occupancyRate, 100)}%`;
            document.getElementById('kpiOccupancyText').textContent = `${slotsUsed}/${totalCapacity} slots estimados`;
            
            const barOcc = document.getElementById('barOccupancy');
            barOcc.className = 'h-full rounded-full transition-all duration-500';
            if(occupancyRate > 90) barOcc.classList.add('bg-red-500'); 
            else if(occupancyRate < 50) barOcc.classList.add('bg-zinc-600'); 
            else barOcc.classList.add('bg-yellow-500'); 

            // Backlog Cr√≠tico (Risco)
            const criticalBacklog = appointments.filter(a => {
                if(a.status !== 'espera') return false;
                const days = Math.floor((now - new Date(a.start_time)) / (1000 * 60 * 60 * 24));
                return days > 7;
            });
            
            document.getElementById('kpiCriticalBacklog').textContent = criticalBacklog.length;
            const elBacklogCard = document.getElementById('cardBacklogRisk');
            elBacklogCard.classList.remove('border-l-red-500', 'border-l-transparent');
            if(criticalBacklog.length > 0) {
                elBacklogCard.classList.add('border-l-red-500');
            }

            // √çndice de Garantia (Financeiro)
            const warrantyApps = validAppointments.filter(a => a.is_warranty);
            const warrantyRate = validAppointments.length > 0 ? Math.round((warrantyApps.length / validAppointments.length) * 100) : 0;
            document.getElementById('kpiWarrantyRate').textContent = `${warrantyRate}%`;
            document.getElementById('statWarrantyTotal').textContent = warrantyApps.length;

            // --- 2. MATRIZ DE EFICI√äNCIA T√âCNICA (TABELA) ---
            const techTableBody = document.getElementById('techPerformanceTable');
            techTableBody.innerHTML = '';
            
            technicians.forEach(tech => {
                // M√©tricas do T√©cnico (Ignora Bloqueios para Volume)
                const myApps = validAppointments.filter(a => (a.technician_id == tech.id || a.technician_id_2 == tech.id));
                const myReturns = myApps.filter(a => a.location && a.location.toLowerCase().includes('retorno')).length;
                const myVolume = myApps.length;
                
                // Status Atual (Inclui Bloqueio para mostrar "Ocupado")
                const isBusyNow = todayApps.some(a => (a.technician_id == tech.id || a.technician_id_2 == tech.id));
                const busyApp = todayApps.find(a => (a.technician_id == tech.id || a.technician_id_2 == tech.id));
                const isBlocked = busyApp && busyApp.status === 'bloqueado';
                
                let statusHtml;
                if (isBlocked) {
                    statusHtml = `<span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 border border-zinc-700"><i class="ph-fill ph-prohibit"></i> Indispon√≠vel</span>`;
                } else if (isBusyNow) {
                    statusHtml = `<span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-bold bg-zinc-800 text-yellow-500 border border-zinc-700"><span class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></span> Ocupado</span>`;
                } else {
                    statusHtml = `<span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-500 border border-zinc-700"><span class="w-1.5 h-1.5 rounded-full bg-zinc-500"></span> Livre</span>`;
                }

                const tr = document.createElement('tr');
                tr.className = "hover:bg-zinc-900 transition-colors";
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-white flex items-center gap-2">
                        <div class="w-2 h-8 ${tech.color ? tech.color.replace('text-zinc-300', 'bg-zinc-700') : 'bg-zinc-700'} rounded-sm"></div>
                        ${tech.name}
                    </td>
                    <td class="px-6 py-4 text-center font-bold">${myVolume}</td>
                    <td class="px-6 py-4 text-center">
                        ${myReturns > 0 ? `<span class="text-red-400 font-bold">${myReturns}</span>` : '<span class="text-zinc-600">-</span>'}
                    </td>
                    <td class="px-6 py-4 text-center">${statusHtml}</td>
                `;
                techTableBody.appendChild(tr);
            });

            // --- 3. LISTA DE ATEN√á√ÉO IMEDIATA (ACTION ITEMS) ---
            const actionList = document.getElementById('actionItemsList');
            actionList.innerHTML = '';
            
            let actionItems = [];
            
            criticalBacklog.forEach(a => {
                const days = Math.floor((now - new Date(a.start_time)) / (1000 * 60 * 60 * 24));
                actionItems.push({
                    type: 'delay',
                    icon: 'ph-clock-countdown',
                    color: 'text-red-500',
                    title: `Atraso Cr√≠tico: ${a.client_name}`,
                    desc: `${days} dias na fila de espera.`,
                    id: a.id
                });
            });

            returnServices.forEach(a => {
                if(a.status === 'pendente' || a.status === 'confirmado') {
                    actionItems.push({
                        type: 'return',
                        icon: 'ph-arrow-u-down-left',
                        color: 'text-yellow-500',
                        title: `Retorno Agendado: ${a.client_name}`,
                        desc: `T√©cnico: ${technicians.find(t=>t.id == a.technician_id)?.name || 'N/A'}`,
                        id: a.id
                    });
                }
            });

            if(actionItems.length === 0) {
                actionList.innerHTML = '<div class="text-center text-zinc-600 text-sm mt-10 italic">Nenhum alerta cr√≠tico. Opera√ß√£o saud√°vel.</div>';
            } else {
                actionItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "bg-zinc-950 p-3 rounded border border-zinc-800 flex items-start gap-3 hover:border-zinc-600 transition cursor-pointer";
                    div.innerHTML = `
                        <i class="ph-fill ${item.icon} ${item.color} text-lg mt-0.5"></i>
                        <div>
                            <div class="text-sm font-bold text-zinc-200">${item.title}</div>
                            <div class="text-xs text-zinc-500">${item.desc}</div>
                        </div>
                    `;
                    div.onclick = () => {
                        const app = appointments.find(a => a.id === item.id);
                        if(app) openAppointmentModal(null, app);
                    };
                    actionList.appendChild(div);
                });
            }

            // --- 4. LOCAIS (CUSTO) ---
            const fieldCount = validAppointments.filter(a => a.location && a.location.toLowerCase().includes('campo')).length;
            const workshopCount = validAppointments.filter(a => a.location && a.location.toLowerCase().includes('oficina')).length;
            const totalLoc = (fieldCount + workshopCount) || 1; 

            const fieldPct = Math.round((fieldCount / totalLoc) * 100);
            const workPct = Math.round((workshopCount / totalLoc) * 100);

            document.getElementById('statFieldPct').textContent = `${fieldPct}%`;
            document.getElementById('statWorkshopPct').textContent = `${workPct}%`;
            document.getElementById('barField').style.width = `${fieldPct}%`;
            document.getElementById('barWorkshop').style.width = `${workPct}%`;
        }

        // --- L√ìGICA DE TIPO DE EVENTO (SERVI√áO vs BLOQUEIO) ---
        function setEventType(type) {
            document.getElementById('currentEventType').value = type;
            const btnService = document.getElementById('typeServiceBtn');
            const btnBlocked = document.getElementById('typeBlockedBtn');
            const clientContainer = document.getElementById('clientFieldsContainer');
            const blockContainer = document.getElementById('blockReasonContainer');
            const tech2Container = document.getElementById('tech2Container');
            const serviceLocation = document.getElementById('serviceLocation');

            if (type === 'service') {
                btnService.classList.add('bg-zinc-600', 'text-white');
                btnService.classList.remove('text-zinc-400');
                btnBlocked.classList.remove('bg-zinc-600', 'text-white');
                btnBlocked.classList.add('text-zinc-400');
                
                clientContainer.classList.remove('hidden');
                blockContainer.classList.add('hidden');
                tech2Container.classList.remove('hidden');
                
                setStatus('pendente'); // Reset status default
            } else {
                btnBlocked.classList.add('bg-zinc-600', 'text-white');
                btnBlocked.classList.remove('text-zinc-400');
                btnService.classList.remove('bg-zinc-600', 'text-white');
                btnService.classList.add('text-zinc-400');

                clientContainer.classList.add('hidden');
                blockContainer.classList.remove('hidden');
                tech2Container.classList.add('hidden'); // Bloqueio √© individual
                
                setStatus('bloqueado');
            }
        }

        function openAppointmentModal(newContext = null, existingApp = null) {
            if (currentUserRole === 'mecanico' && !existingApp) return;

            const modal = document.getElementById('appointmentModal');
            const form = document.getElementById('appointmentForm');
            const title = document.getElementById('modalTitle');
            const btnDelete = document.getElementById('btnDelete');
            const statusContainer = document.getElementById('statusContainer');
            const schedulingFields = document.getElementById('schedulingFields');
            const btnSaveWait = document.getElementById('btnSaveWait');
            const btnSave = document.getElementById('btnSave');
            const inputs = form.querySelectorAll('input, select, textarea');
            const repeatContainer = document.getElementById('repeatContainer');

            document.getElementById('fileInput').value = "";
            document.getElementById('uploadStatus').textContent = "";
            document.getElementById('btnUpload').disabled = true;
            document.getElementById('btnUpload').textContent = "Enviar";

            form.reset();
            currentEditingId = null;

            inputs.forEach(input => input.disabled = false);
            btnSave.classList.remove('hidden');
            
            schedulingFields.classList.remove('hidden');
            btnSaveWait.classList.remove('hidden');

            if (existingApp) {
                currentEditingId = existingApp.id;
                repeatContainer.classList.add('hidden'); // N√£o pode repetir na edi√ß√£o
                renderAttachmentsList(existingApp.attachments);

                // Detectar se √© bloqueio
                if (existingApp.status === 'bloqueado') {
                    setEventType('blocked');
                    let reason = 'OUTROS';
                    if(existingApp.client_name.includes('-')) {
                        reason = existingApp.client_name.split('-')[1].trim();
                    }
                    document.getElementById('blockReason').value = reason;
                } else {
                    setEventType('service');
                    document.getElementById('clientName').value = existingApp.client_name;
                    document.getElementById('clientPhone').value = existingApp.client_phone || '';
                    document.getElementById('tractorModel').value = existingApp.tractor_model || '';
                    document.getElementById('monoblock').value = existingApp.monoblock || '';
                    document.getElementById('isWarranty').checked = existingApp.is_warranty;
                }

                if (currentUserRole === 'mecanico') {
                    title.textContent = "Detalhes do Servi√ßo";
                    btnDelete.classList.add('hidden');
                    btnSaveWait.classList.add('hidden');
                    btnSave.classList.add('hidden'); 
                    statusContainer.classList.add('hidden'); 
                    inputs.forEach(input => input.disabled = true);
                } else {
                    title.textContent = "Editar Agendamento";
                    btnDelete.classList.remove('hidden');
                    statusContainer.classList.remove('hidden');
                    btnSaveWait.classList.add('hidden');
                }

                document.getElementById('serviceLocation').value = existingApp.location;
                document.getElementById('description').value = existingApp.description || '';
                document.getElementById('technicianSelect').value = existingApp.technician_id || '';
                document.getElementById('technicianSelect2').value = existingApp.technician_id_2 || '';
                
                if (existingApp.status === 'espera') {
                    schedulingFields.classList.add('hidden');
                } else {
                    const start = existingApp.start_time;
                    const h = start.getHours();
                    const durationMinutes = (existingApp.end_time - start) / 60000;
                    
                    if (durationMinutes > 400) { 
                        document.getElementById('periodSelect').value = 'full_day';
                        document.getElementById('durationSlots').value = "3";
                    } else {
                        document.getElementById('periodSelect').value = (h < 12) ? 'morning' : 'afternoon';
                        let slots = Math.round(durationMinutes / 60);
                        if(slots < 1) slots = 1;
                        document.getElementById('durationSlots').value = slots;
                    }
                }

                setStatus(existingApp.status || 'pendente');

            } else {
                title.textContent = "Novo Agendamento";
                setEventType('service'); // Default
                btnDelete.classList.add('hidden');
                statusContainer.classList.add('hidden');
                repeatContainer.classList.remove('hidden'); // Habilita repeti√ß√£o
                document.getElementById('repeatDays').value = 1;
                document.getElementById('currentStatus').value = 'pendente';
                document.getElementById('durationSlots').value = "1";
                renderAttachmentsList([]); 

                if (newContext) {
                    document.getElementById('technicianSelect').value = newContext.techId;
                    if (newContext.slotId !== undefined) {
                        const slot = WORK_SLOTS.find(s => s.id === newContext.slotId);
                        if(slot) {
                            document.getElementById('periodSelect').value = slot.type;
                        }
                    }
                }
            }
            modal.classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function setStatus(status) {
            if (currentUserRole === 'mecanico') return;

            document.getElementById('currentStatus').value = status;
            const schedulingFields = document.getElementById('schedulingFields');
            if (status === 'espera') {
                schedulingFields.classList.add('hidden');
            } else {
                schedulingFields.classList.remove('hidden');
            }
            document.querySelectorAll('.status-btn').forEach(btn => {
                if(btn.dataset.status === status) {
                    btn.classList.remove('opacity-50');
                    btn.classList.add('ring-2', 'ring-offset-1', 'ring-yellow-500');
                } else {
                    btn.classList.add('opacity-50');
                    btn.classList.remove('ring-2', 'ring-offset-1', 'ring-yellow-500');
                }
            });
        }

        async function saveAppointment(forceStatus = null) {
            const eventType = document.getElementById('currentEventType').value;
            let status = forceStatus || document.getElementById('currentStatus').value;
            
            // Valida√ß√µes
            if (status !== 'espera') {
                const techId = document.getElementById('technicianSelect').value;
                if (!techId) return alert("Selecione um t√©cnico principal.");
            }

            let clientName = "";
            let tractorModel = "";
            let location = "";

            if (eventType === 'blocked') {
                const reason = document.getElementById('blockReason').value;
                clientName = `BLOQUEIO - ${reason}`;
                tractorModel = "Indispon√≠vel";
                location = "Indispon√≠vel";
                status = 'bloqueado';
            } else {
                clientName = document.getElementById('clientName').value;
                if (!clientName) return alert("Nome do cliente √© obrigat√≥rio.");
                tractorModel = document.getElementById('tractorModel').value;
                location = document.getElementById('serviceLocation').value;
            }

            const repeatDays = parseInt(document.getElementById('repeatDays').value) || 1;
            
            // Se estiver editando, n√£o repete (ignora o campo, pois est√° oculto)
            const daysToCreate = currentEditingId ? 1 : repeatDays;

            for (let i = 0; i < daysToCreate; i++) {
                
                // Calcula a data base para esta itera√ß√£o (Hoje + i dias)
                const baseDate = new Date(currentDate);
                baseDate.setDate(baseDate.getDate() + i);

                const payload = {
                    client_name: clientName,
                    client_phone: document.getElementById('clientPhone').value,
                    tractor_model: tractorModel,
                    monoblock: document.getElementById('monoblock').value,
                    is_warranty: document.getElementById('isWarranty').checked,
                    location: location,
                    description: document.getElementById('description').value,
                    status: status
                };

                if (status !== 'espera') {
                    const techId = document.getElementById('technicianSelect').value;
                    const techId2 = document.getElementById('technicianSelect2').value;
                    const period = document.getElementById('periodSelect').value;
                    
                    const startDateTime = new Date(baseDate);
                    let durationMinutes = 60; 

                    if (period === 'full_day') {
                        startDateTime.setHours(8, 0, 0, 0);
                        durationMinutes = 540; 
                    } else {
                        const slots = parseInt(document.getElementById('durationSlots').value);
                        let hour = 8, min = 0;
                        if (period === 'afternoon') { hour = 13; min = 30; }
                        startDateTime.setHours(hour, min, 0, 0);
                        durationMinutes = slots * 60;
                    }

                    const endDateTime = new Date(startDateTime.getTime() + durationMinutes * 60000); 

                    payload.technician_id = parseInt(techId) || techId;
                    payload.technician_id_2 = (techId2 && eventType !== 'blocked') ? (parseInt(techId2) || techId2) : null;
                    payload.start_time = startDateTime.toISOString();
                    payload.end_time = endDateTime.toISOString();
                } else {
                    // Se for espera, n√£o tem data, ent√£o n√£o faz sentido repetir loop, mas o c√≥digo
                    // vai criar 1 registro se daysToCreate for > 1 e status for espera?
                    // Geralmente backlog n√£o tem data, ent√£o loop n√£o afeta muito, mas criaria duplicatas.
                    // Vamos for√ßar daysToCreate = 1 se status == espera.
                    if (i > 0 && status === 'espera') break; 

                    payload.technician_id = null;
                    payload.technician_id_2 = null;
                    payload.start_time = new Date().toISOString();
                    payload.end_time = new Date().toISOString();
                }

                if (isDemoMode) {
                    if (currentEditingId) {
                        // Edi√ß√£o (apenas 1 itera√ß√£o)
                        const idx = appointments.findIndex(a => a.id === currentEditingId);
                        appointments[idx] = { 
                            ...appointments[idx], 
                            ...payload, 
                            start_time: new Date(payload.start_time), 
                            end_time: new Date(payload.end_time) 
                        };
                    } else {
                        // Novo (com loop)
                        appointments.push({ 
                            id: Date.now() + i, // ID √∫nico simples
                            ...payload, 
                            start_time: new Date(payload.start_time), 
                            end_time: new Date(payload.end_time),
                            attachments: [] 
                        });
                    }
                } else {
                    if (currentEditingId) {
                        const { error } = await supabaseClient.from('appointments').update(payload).eq('id', currentEditingId);
                        if(error) alert(error.message);
                    } else {
                        // Pode ser otimizado com insertMany se suportado, mas loop simples funciona
                        const { error } = await supabaseClient.from('appointments').insert([payload]);
                        if(error) alert(error.message);
                    }
                }
            } // Fim Loop

            if (isDemoMode) {
                saveLocalData(); 
                updateAllViews(); 
                closeModal('appointmentModal');
            } else {
                loadDataSupabase();
                closeModal('appointmentModal');
            }
        }

        async function deleteAppointment() {
            if (!currentEditingId || !confirm("Tem certeza que deseja excluir?")) return;
            if (isDemoMode) {
                appointments = appointments.filter(a => a.id !== currentEditingId);
                saveLocalData(); 
                updateAllViews();
            } else {
                await supabaseClient.from('appointments').delete().eq('id', currentEditingId);
                loadDataSupabase();
            }
            closeModal('appointmentModal');
        }

        function openTechnicianModal() { document.getElementById('technicianModal').classList.remove('hidden'); renderTechListModal(); }
        function renderTechListModal() { 
            const list = document.getElementById('techList'); list.innerHTML = '';
            technicians.forEach(t => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-zinc-800 p-2 rounded';
                div.innerHTML = `<span class="font-medium text-zinc-300">${t.name}</span>${technicians.length > 1 ? `<button onclick="removeTechnician('${t.id}')" class="text-red-500 hover:text-red-400"><i class="ph ph-trash"></i></button>` : ''}`;
                list.appendChild(div);
            });
        }
        async function addTechnician() {
            const name = document.getElementById('newTechName').value;
            if(!name) return;
            const newTech = { name, color: 'bg-zinc-800 border-zinc-700 text-zinc-300' };
            if (isDemoMode) { 
                technicians.push({ id: Date.now(), ...newTech }); 
                saveLocalData(); 
                updateAllViews(); 
            }
            else { await supabaseClient.from('technicians').insert([newTech]); loadDataSupabase(); renderTechListModal(); }
            document.getElementById('newTechName').value = '';
        }
        async function removeTechnician(id) {
            if (isDemoMode) { 
                technicians = technicians.filter(t => t.id != id); 
                saveLocalData(); 
                updateAllViews(); 
            }
            else { await supabaseClient.from('technicians').delete().eq('id', id); loadDataSupabase(); }
        }

        function updateAllViews() {
            renderGrid();
            renderTechListModal();
            renderTechniciansHeader();
            renderWaitingList();
            renderAdvancedDashboard(); // Atualiza o novo dashboard sempre
            renderTechnicianSelect(); 
            updateInterfaceForRole();
        }
    </script>
</body>
</html>